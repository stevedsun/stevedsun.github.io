<!doctype html><html lang=zh><head><meta charset=utf-8><title>电波障害</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta property="og:title" content="Python 巧妙地将rpc接口封装成pythonic的链式调用"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://sund.site/posts/2016/10/python-%E5%B7%A7%E5%A6%99%E5%9C%B0%E5%B0%86rpc%E6%8E%A5%E5%8F%A3%E5%B0%81%E8%A3%85%E6%88%90pythonic%E7%9A%84%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8/"><meta itemprop=name content="Python 巧妙地将rpc接口封装成pythonic的链式调用"><meta itemprop=description content><meta name=twitter:card content="summary"><meta name=twitter:title content="Python 巧妙地将rpc接口封装成pythonic的链式调用"><meta name=twitter:description content><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=favicon-32.png><link rel=stylesheet href=https://sund.site/scss/style.min.ae23adef903c07f0d9df75832e4082f1ee49b423c638835fa33420622f3a6863.css></head><body><header><div class="header header-frame"><div><h1 class=header__title>Python 巧妙地将rpc接口封装成pythonic的链式调用</h1></div><nav class=header-nav><ul class="header-nav-list header-nav-list--menu"><li class=header-nav-list__item><a class=header-nav-list__link href=/about/><span>About</span></a></li></ul><button class=header-nav-list__nav-btn>navigation</button></nav><button class=mb-header__menu-btn>
<span class=mb-header__menu-btn-line></span><span class=mb-header__menu-btn-line></span><span class=mb-header__menu-btn-line></span></button></div><nav id=mobile-header-nav class=mb-header-nav><button class="mb-header-nav__close-btn flex-center"><svg class="mb-header-nav__svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/><path d="M0 0h24v24H0z" fill="none"/></svg></button><div class=mb-header-nav__wrapper><div class=mb-header-nav__container><svg width="240" height="72" viewBox="0 0 240 72" class="mb-header-nav__title"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Tags</text></svg><ul class=mb-header-nav-list><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=https://sund.site/tags/python/>python</a></li></ul></div><div class=mb-header-nav__container><svg width="240" height="72" viewBox="0 0 240 72" class="mb-header-nav__title"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Menu</text></svg><ul class=mb-header-nav-list><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=/about/>About</a></li></ul></div></div></nav></header><div id=content><article class=post><div class=post-content><p>这是一个外国人实现的Zabbix(一个开源监控工具)的Python Client——pyzabbix里的代码片段。</p><h2 id=rpc调用>RPC调用</h2><p>Rpc调用的流程是向rpc服务端指定的uri(如http://www.abc.com/jsonrpc.php) 发送json(或其他双方约定格式)数据包，数据包里有rpc版本信息、方法名、参数等。下面<code>Zabbix</code>类里的<code>do_request</code>方法就完成了将方法名和方法参数打包json后发送请求的过程。</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>Zabbix</span>(<span style=color:#0086b3>object</span>):
    <span style=color:#998;font-style:italic># ... skip other class methods</span>
    
    <span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>do_request</span>(<span style=color:#999>self</span>, method, params<span style=color:#000;font-weight:700>=</span><span style=color:#999>None</span>):
        request_json <span style=color:#000;font-weight:700>=</span> {
            <span style=color:#d14>&#39;jsonrpc&#39;</span>: <span style=color:#d14>&#39;2.0&#39;</span>,
            <span style=color:#d14>&#39;method&#39;</span>: method,
            <span style=color:#d14>&#39;params&#39;</span>: params <span style=color:#000;font-weight:700>or</span> {},
            <span style=color:#d14>&#39;id&#39;</span>: <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>id,
        }

        response <span style=color:#000;font-weight:700>=</span> <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>session<span style=color:#000;font-weight:700>.</span>post(
            <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>url,
            data<span style=color:#000;font-weight:700>=</span>json<span style=color:#000;font-weight:700>.</span>dumps(request_json),
            timeout<span style=color:#000;font-weight:700>=</span><span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>timeout
        )
</code></pre></div><h2 id=技巧>技巧</h2><p>但是为了方便，我们在python里一般使用<code>zabbixclient.host.get(args)</code>这样的链式调用，而不用<code>zabbixclient('host.get', args)</code>这样的调用方式。pyzabbix的作者巧妙的实现了这样的转换。</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>Zabbix</span>(<span style=color:#0086b3>object</span>):
    <span style=color:#998;font-style:italic># ... skip other class methods</span>
    
    <span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>do_request</span>(<span style=color:#999>self</span>, method, params<span style=color:#000;font-weight:700>=</span><span style=color:#999>None</span>):
        request_json <span style=color:#000;font-weight:700>=</span> {
            <span style=color:#d14>&#39;jsonrpc&#39;</span>: <span style=color:#d14>&#39;2.0&#39;</span>,
            <span style=color:#d14>&#39;method&#39;</span>: method,
            <span style=color:#d14>&#39;params&#39;</span>: params <span style=color:#000;font-weight:700>or</span> {},
            <span style=color:#d14>&#39;id&#39;</span>: <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>id,
        }

        response <span style=color:#000;font-weight:700>=</span> <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>session<span style=color:#000;font-weight:700>.</span>post(
            <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>url,
            data<span style=color:#000;font-weight:700>=</span>json<span style=color:#000;font-weight:700>.</span>dumps(request_json),
            timeout<span style=color:#000;font-weight:700>=</span><span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>timeout
        )

    <span style=color:#998;font-style:italic># python内建方法，当获取某个对象的属性时，调用该对象的该方法</span>
    <span style=color:#000;font-weight:700>def</span> __getattr__(<span style=color:#999>self</span>, attr):
        <span style=color:#d14>&#34;&#34;&#34;Dynamically create an object class (ie: host)&#34;&#34;&#34;</span>
        <span style=color:#998;font-style:italic># 此处把self传给ZabbixAPIObjectClass的self.parent</span>
        <span style=color:#000;font-weight:700>return</span> ZabbixAPIObjectClass(attr, <span style=color:#999>self</span>)


<span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>ZabbixAPIObjectClass</span>(<span style=color:#0086b3>object</span>):
    <span style=color:#000;font-weight:700>def</span> __init__(<span style=color:#999>self</span>, name, parent):
        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>name <span style=color:#000;font-weight:700>=</span> name
        <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>parent <span style=color:#000;font-weight:700>=</span> parent

    <span style=color:#000;font-weight:700>def</span> __getattr__(<span style=color:#999>self</span>, attr):
        <span style=color:#d14>&#34;&#34;&#34;Dynamically create a method (ie: get)&#34;&#34;&#34;</span>

        <span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>fn</span>(<span style=color:#000;font-weight:700>*</span>args, <span style=color:#000;font-weight:700>**</span>kwargs):
            <span style=color:#000;font-weight:700>if</span> args <span style=color:#000;font-weight:700>and</span> kwargs:
                <span style=color:#000;font-weight:700>raise</span> <span style=color:#900;font-weight:700>TypeError</span>(<span style=color:#d14>&#34;Found both args and kwargs&#34;</span>)
        
            <span style=color:#998;font-style:italic># 此处把父类传进来的方法名name和子方法attr拼成rpc的方法名</span>
            <span style=color:#000;font-weight:700>return</span> <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>parent<span style=color:#000;font-weight:700>.</span>do_request(
                <span style=color:#d14>&#39;{0}.{1}&#39;</span><span style=color:#000;font-weight:700>.</span>format(<span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>name, attr),
                args <span style=color:#000;font-weight:700>or</span> kwargs
            )[<span style=color:#d14>&#39;result&#39;</span>]

        <span style=color:#000;font-weight:700>return</span> fn
</code></pre></div><p>类似地，很多接口的实现都可以照搬这种方式把参数调用改成链式调用，如pymongo，redis-py等。</p><h2 id=参考资料>参考资料：</h2><p><a href=https://github.com/lukecyca/pyzabbix>https://github.com/lukecyca/pyzabbix</a></p></div></article><button class=floating-button>
<a class=floating-button__link href=https://sund.site><span>home</span></a></button></div><footer class=post-footer><div class=footer><div>© 2021, Steve Sun</div><div class=footer__socials><a href=https://twitter.com/way2steve target=_blank class=social-link title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0v24h24V0H0zm18.862 9.237c.208 4.617-3.235 9.765-9.33 9.765-1.854.0-3.579-.543-5.032-1.475 1.742.205 3.48-.278 4.86-1.359-1.437-.027-2.649-.976-3.066-2.28.515.098 1.021.069 1.482-.056-1.579-.317-2.668-1.739-2.633-3.26.442.246.949.394 1.486.411-1.461-.977-1.875-2.907-1.016-4.383 1.619 1.986 4.038 3.293 6.766 3.43-.479-2.053 1.079-4.03 3.198-4.03.944.0 1.797.398 2.396 1.037.748-.147 1.451-.42 2.085-.796-.245.767-.766 1.41-1.443 1.816.664-.08 1.297-.256 1.885-.517-.44.656-.997 1.234-1.638 1.697z"/></svg></a><a href=https://github.com/stevedsun target=_blank class=social-link title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0v24h24V0H0zm14.534 19.59c-.406.078-.534-.171-.534-.384v-2.195c0-.747-.262-1.233-.55-1.481 1.782-.198 3.654-.875 3.654-3.947.0-.874-.311-1.588-.824-2.147.083-.202.357-1.016-.079-2.117.0.0-.671-.215-2.198.82-.639-.18-1.323-.267-2.003-.271-.68.003-1.364.091-2.003.269-1.528-1.035-2.2-.82-2.2-.82-.434 1.102-.16 1.915-.077 2.118-.512.56-.824 1.273-.824 2.147.0 3.064 1.867 3.751 3.645 3.954-.229.2-.436.552-.508 1.07-.457.204-1.614.557-2.328-.666.0.0-.423-.768-1.227-.825.0.0-.78-.01-.055.487.0.0.525.246.889 1.17.0.0.463 1.428 2.688.944v1.489c0 .211-.129.459-.528.385-3.18-1.057-5.472-4.056-5.472-7.59.0-4.419 3.582-8 8-8s8 3.581 8 8c0 3.533-2.289 6.531-5.466 7.59z"/></svg></a></div></div></footer><script src=https://sund.site/js/script.js></script></body></html>