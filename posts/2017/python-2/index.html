<!doctype html><html lang=zh-CN><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://sund.site/favicon.ico><title>ã€ŠPythonæºç å‰–æã€‹ç¬¬äºŒéƒ¨åˆ†â€”â€”Pythonè™šæ‹ŸæœºåŸºç¡€ | Steve Sun</title>
<meta name=title content="ã€ŠPythonæºç å‰–æã€‹ç¬¬äºŒéƒ¨åˆ†â€”â€”Pythonè™šæ‹ŸæœºåŸºç¡€"><meta name=description content="Python æ‰§è¡Œç¯å¢ƒ

åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œè¿™äº›åŒ…å«åœ¨ Python æºä»£ç ä¸­çš„é™æ€ä¿¡æ¯éƒ½ä¼šè¢« Python ç¼–è¯‘å™¨æ”¶é›†èµ·æ¥ï¼Œç¼–è¯‘çš„ç»“æœä¸­åŒ…å«äº†å­—ç¬¦ä¸²ï¼Œå¸¸é‡å€¼ï¼Œå­—èŠ‚ç ç­‰åœ¨æºä»£ç ä¸­å‡ºç°çš„ä¸€åˆ‡æœ‰ç”¨çš„é™æ€ä¿¡æ¯ã€‚åœ¨ Python è¿è¡ŒæœŸé—´ï¼Œè¿™äº›æºæ–‡ä»¶ä¸­æä¾›çš„é™æ€ä¿¡æ¯æœ€ç»ˆä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªè¿è¡Œæ—¶çš„å¯¹è±¡ä¸­ï¼Œå½“ Python è¿è¡Œç»“æŸåï¼Œè¿™ä¸ªè¿è¡Œæ—¶å¯¹è±¡ä¸­æ‰€åŒ…å«çš„ä¿¡æ¯ç”šè‡³è¿˜ä¼šè¢«å­˜å‚¨åœ¨ä¸€ç§æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå¯¹è±¡å’Œæ–‡ä»¶å°±æ˜¯æˆ‘ä»¬è¿™ç« æ¢ç´¢çš„é‡ç‚¹ï¼šPyCodeObject å¯¹è±¡å’Œ pyc æ–‡ä»¶ã€‚


åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œç¼–è¯‘ç»“æœå­˜åœ¨äºå†…å­˜çš„ PyCodeObject å¯¹è±¡ä¸­ï¼›è€Œ Python ç»“æŸè¿è¡Œåï¼Œç¼–è¯‘ç»“æœåˆè¢«ä¿å­˜åˆ°äº† pyc æ–‡ä»¶ä¸­ã€‚å½“ä¸‹ä¸€æ¬¡è¿è¡Œç›¸åŒçš„ç¨‹åºæ—¶ï¼ŒPython ä¼šæ ¹æ® pyc æ–‡ä»¶ä¸­è®°å½•çš„ç¼–è¯‘ç»“æœç›´æ¥å»ºç«‹å†…å­˜ä¸­çš„ PyCodeObject å¯¹è±¡ï¼Œè€Œä¸ç”¨å†æ¬¡å¯¹æºæ–‡ä»¶è¿›è¡Œç¼–è¯‘äº†ã€‚

ä»æ–‡ç« æ‘˜å½•å¯è§ï¼Œpython ç”Ÿæˆçš„ä¸æ˜¯ç¼–è¯‘åçš„æ–‡ä»¶ï¼Œè€Œæ˜¯.pyæ–‡ä»¶å¯¹åº”çš„é™æ€ä¿¡æ¯â€”â€”PyCodeObjectï¼Œè¿™é‡ŒåŒ…æ‹¬äº†å­—èŠ‚ç æŒ‡ä»¤åºåˆ—ã€å­—ç¬¦ä¸²ã€å¸¸é‡ã€‚æ¯ä¸ªåå­—ç©ºé—´(ç±»ã€æ¨¡å—ã€å‡½æ•°)éƒ½å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ PyCodeObjectã€‚(python è¿ç¼–è¯‘åçš„æ–‡ä»¶é‡Œå­˜çš„éƒ½æ˜¯ä¸ªå¯¹è±¡ï¼)
ä¸è¢« import çš„ py æ–‡ä»¶ä¸ä¼šç”Ÿæˆ pycã€‚æ ‡å‡†åº“é‡Œæœ‰ py_compile ç­‰æ–¹æ³•ä¹Ÿå¯ä»¥ç”Ÿæˆ pycã€‚
import æœºåˆ¶ å¯¼å…¥æŸä¸ªæ¨¡å—æ—¶ï¼Œå…ˆæŸ¥æ‰¾å¯¹åº”çš„ pycï¼Œå¦‚æœæ²¡æœ‰ pyc å°±ç”Ÿæˆç„¶å import è¿™ä¸ª pycã€‚(æ‰€ä»¥å®é™…å¯¼å…¥çš„å¹¶ä¸æ˜¯ py æ–‡ä»¶ï¼Œè€Œæ˜¯ py æ–‡ä»¶ç¼–è¯‘åçš„ PyCodeObject)ã€‚
PyFrameObject Python ç¨‹åºè¿è¡Œæ—¶çš„ã€Œæ‰§è¡Œç¯å¢ƒã€ã€‚å‚è€ƒæ“ä½œç³»ç»Ÿæ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ã€‚Python ä¹Ÿæ˜¯å°†å‡½æ•°å¯¹åº”çš„æ‰§è¡Œç¯å¢ƒå°è£…æˆæ ˆå¸§çš„å½¢å¼åŠ è½½è¿›å†…å­˜ã€‚
typedef struct _frame {
    PyObject_VAR_HEAD
    struct _frame *f_back;  //æ‰§è¡Œç¯å¢ƒé“¾ä¸Šçš„å‰ä¸€ä¸ªframe
    PyCodeObject *f_code;   //PyCodeObjectå¯¹è±¡
    PyObject *f_builtins;   //builtinåå­—ç©ºé—´
    PyObject *f_globals;    //globalåå­—ç©ºé—´
    PyObject *f_locals;     //localåå­—ç©ºé—´
    PyObject **f_valuestack;    //è¿è¡Œæ—¶æ ˆçš„æ ˆåº•ä½ç½®
    PyObject **f_stacktop;      //è¿è¡Œæ—¶æ ˆçš„æ ˆé¡¶ä½ç½®
    â€¦â€¦
    int f_lasti;        //ä¸Šä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤åœ¨f_codeä¸­çš„åç§»ä½ç½®
    int f_lineno;       //å½“å‰å­—èŠ‚ç å¯¹åº”çš„æºä»£ç è¡Œ
    â€¦â€¦
    //åŠ¨æ€å†…å­˜ï¼Œç»´æŠ¤ï¼ˆå±€éƒ¨å˜é‡+cellå¯¹è±¡é›†åˆ+freeå¯¹è±¡é›†åˆ+è¿è¡Œæ—¶æ ˆï¼‰æ‰€éœ€è¦çš„ç©ºé—´
    PyObject *f_localsplus[1];
} PyFrameObject;
Python æ ‡å‡†åº“çš„sys._getframe()å¯ä»¥åŠ¨æ€çš„åœ¨ç¨‹åºæ‰§è¡Œæ—¶è·å–å½“å‰å†…å­˜ä¸­æ´»è·ƒçš„ PyFrameObject ä¿¡æ¯ã€‚"><meta name=keywords content="python,"><link rel=canonical href=https://sund.site/posts/2017/python-2/><meta property="og:url" content="https://sund.site/posts/2017/python-2/"><meta property="og:site_name" content="Steve Sun"><meta property="og:title" content="ã€ŠPythonæºç å‰–æã€‹ç¬¬äºŒéƒ¨åˆ†â€”â€”Pythonè™šæ‹ŸæœºåŸºç¡€"><meta property="og:description" content="Python æ‰§è¡Œç¯å¢ƒ åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œè¿™äº›åŒ…å«åœ¨ Python æºä»£ç ä¸­çš„é™æ€ä¿¡æ¯éƒ½ä¼šè¢« Python ç¼–è¯‘å™¨æ”¶é›†èµ·æ¥ï¼Œç¼–è¯‘çš„ç»“æœä¸­åŒ…å«äº†å­—ç¬¦ä¸²ï¼Œå¸¸é‡å€¼ï¼Œå­—èŠ‚ç ç­‰åœ¨æºä»£ç ä¸­å‡ºç°çš„ä¸€åˆ‡æœ‰ç”¨çš„é™æ€ä¿¡æ¯ã€‚åœ¨ Python è¿è¡ŒæœŸé—´ï¼Œè¿™äº›æºæ–‡ä»¶ä¸­æä¾›çš„é™æ€ä¿¡æ¯æœ€ç»ˆä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªè¿è¡Œæ—¶çš„å¯¹è±¡ä¸­ï¼Œå½“ Python è¿è¡Œç»“æŸåï¼Œè¿™ä¸ªè¿è¡Œæ—¶å¯¹è±¡ä¸­æ‰€åŒ…å«çš„ä¿¡æ¯ç”šè‡³è¿˜ä¼šè¢«å­˜å‚¨åœ¨ä¸€ç§æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå¯¹è±¡å’Œæ–‡ä»¶å°±æ˜¯æˆ‘ä»¬è¿™ç« æ¢ç´¢çš„é‡ç‚¹ï¼šPyCodeObject å¯¹è±¡å’Œ pyc æ–‡ä»¶ã€‚
åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œç¼–è¯‘ç»“æœå­˜åœ¨äºå†…å­˜çš„ PyCodeObject å¯¹è±¡ä¸­ï¼›è€Œ Python ç»“æŸè¿è¡Œåï¼Œç¼–è¯‘ç»“æœåˆè¢«ä¿å­˜åˆ°äº† pyc æ–‡ä»¶ä¸­ã€‚å½“ä¸‹ä¸€æ¬¡è¿è¡Œç›¸åŒçš„ç¨‹åºæ—¶ï¼ŒPython ä¼šæ ¹æ® pyc æ–‡ä»¶ä¸­è®°å½•çš„ç¼–è¯‘ç»“æœç›´æ¥å»ºç«‹å†…å­˜ä¸­çš„ PyCodeObject å¯¹è±¡ï¼Œè€Œä¸ç”¨å†æ¬¡å¯¹æºæ–‡ä»¶è¿›è¡Œç¼–è¯‘äº†ã€‚
ä»æ–‡ç« æ‘˜å½•å¯è§ï¼Œpython ç”Ÿæˆçš„ä¸æ˜¯ç¼–è¯‘åçš„æ–‡ä»¶ï¼Œè€Œæ˜¯.pyæ–‡ä»¶å¯¹åº”çš„é™æ€ä¿¡æ¯â€”â€”PyCodeObjectï¼Œè¿™é‡ŒåŒ…æ‹¬äº†å­—èŠ‚ç æŒ‡ä»¤åºåˆ—ã€å­—ç¬¦ä¸²ã€å¸¸é‡ã€‚æ¯ä¸ªåå­—ç©ºé—´(ç±»ã€æ¨¡å—ã€å‡½æ•°)éƒ½å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ PyCodeObjectã€‚(python è¿ç¼–è¯‘åçš„æ–‡ä»¶é‡Œå­˜çš„éƒ½æ˜¯ä¸ªå¯¹è±¡ï¼)
ä¸è¢« import çš„ py æ–‡ä»¶ä¸ä¼šç”Ÿæˆ pycã€‚æ ‡å‡†åº“é‡Œæœ‰ py_compile ç­‰æ–¹æ³•ä¹Ÿå¯ä»¥ç”Ÿæˆ pycã€‚
import æœºåˆ¶ å¯¼å…¥æŸä¸ªæ¨¡å—æ—¶ï¼Œå…ˆæŸ¥æ‰¾å¯¹åº”çš„ pycï¼Œå¦‚æœæ²¡æœ‰ pyc å°±ç”Ÿæˆç„¶å import è¿™ä¸ª pycã€‚(æ‰€ä»¥å®é™…å¯¼å…¥çš„å¹¶ä¸æ˜¯ py æ–‡ä»¶ï¼Œè€Œæ˜¯ py æ–‡ä»¶ç¼–è¯‘åçš„ PyCodeObject)ã€‚
PyFrameObject Python ç¨‹åºè¿è¡Œæ—¶çš„ã€Œæ‰§è¡Œç¯å¢ƒã€ã€‚å‚è€ƒæ“ä½œç³»ç»Ÿæ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ã€‚Python ä¹Ÿæ˜¯å°†å‡½æ•°å¯¹åº”çš„æ‰§è¡Œç¯å¢ƒå°è£…æˆæ ˆå¸§çš„å½¢å¼åŠ è½½è¿›å†…å­˜ã€‚
typedef struct _frame { PyObject_VAR_HEAD struct _frame *f_back; //æ‰§è¡Œç¯å¢ƒé“¾ä¸Šçš„å‰ä¸€ä¸ªframe PyCodeObject *f_code; //PyCodeObjectå¯¹è±¡ PyObject *f_builtins; //builtinåå­—ç©ºé—´ PyObject *f_globals; //globalåå­—ç©ºé—´ PyObject *f_locals; //localåå­—ç©ºé—´ PyObject **f_valuestack; //è¿è¡Œæ—¶æ ˆçš„æ ˆåº•ä½ç½® PyObject **f_stacktop; //è¿è¡Œæ—¶æ ˆçš„æ ˆé¡¶ä½ç½® â€¦â€¦ int f_lasti; //ä¸Šä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤åœ¨f_codeä¸­çš„åç§»ä½ç½® int f_lineno; //å½“å‰å­—èŠ‚ç å¯¹åº”çš„æºä»£ç è¡Œ â€¦â€¦ //åŠ¨æ€å†…å­˜ï¼Œç»´æŠ¤ï¼ˆå±€éƒ¨å˜é‡+cellå¯¹è±¡é›†åˆ+freeå¯¹è±¡é›†åˆ+è¿è¡Œæ—¶æ ˆï¼‰æ‰€éœ€è¦çš„ç©ºé—´ PyObject *f_localsplus[1]; } PyFrameObject; Python æ ‡å‡†åº“çš„sys._getframe()å¯ä»¥åŠ¨æ€çš„åœ¨ç¨‹åºæ‰§è¡Œæ—¶è·å–å½“å‰å†…å­˜ä¸­æ´»è·ƒçš„ PyFrameObject ä¿¡æ¯ã€‚"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-07-13T00:00:00+00:00"><meta property="article:modified_time" content="2017-07-13T00:00:00+00:00"><meta property="article:tag" content="Python"><meta property="og:image" content="https://sund.site/images/share.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sund.site/images/share.png"><meta name=twitter:title content="ã€ŠPythonæºç å‰–æã€‹ç¬¬äºŒéƒ¨åˆ†â€”â€”Pythonè™šæ‹ŸæœºåŸºç¡€"><meta name=twitter:description content="Python æ‰§è¡Œç¯å¢ƒ åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œè¿™äº›åŒ…å«åœ¨ Python æºä»£ç ä¸­çš„é™æ€ä¿¡æ¯éƒ½ä¼šè¢« Python ç¼–è¯‘å™¨æ”¶é›†èµ·æ¥ï¼Œç¼–è¯‘çš„ç»“æœä¸­åŒ…å«äº†å­—ç¬¦ä¸²ï¼Œå¸¸é‡å€¼ï¼Œå­—èŠ‚ç ç­‰åœ¨æºä»£ç ä¸­å‡ºç°çš„ä¸€åˆ‡æœ‰ç”¨çš„é™æ€ä¿¡æ¯ã€‚åœ¨ Python è¿è¡ŒæœŸé—´ï¼Œè¿™äº›æºæ–‡ä»¶ä¸­æä¾›çš„é™æ€ä¿¡æ¯æœ€ç»ˆä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªè¿è¡Œæ—¶çš„å¯¹è±¡ä¸­ï¼Œå½“ Python è¿è¡Œç»“æŸåï¼Œè¿™ä¸ªè¿è¡Œæ—¶å¯¹è±¡ä¸­æ‰€åŒ…å«çš„ä¿¡æ¯ç”šè‡³è¿˜ä¼šè¢«å­˜å‚¨åœ¨ä¸€ç§æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå¯¹è±¡å’Œæ–‡ä»¶å°±æ˜¯æˆ‘ä»¬è¿™ç« æ¢ç´¢çš„é‡ç‚¹ï¼šPyCodeObject å¯¹è±¡å’Œ pyc æ–‡ä»¶ã€‚
åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œç¼–è¯‘ç»“æœå­˜åœ¨äºå†…å­˜çš„ PyCodeObject å¯¹è±¡ä¸­ï¼›è€Œ Python ç»“æŸè¿è¡Œåï¼Œç¼–è¯‘ç»“æœåˆè¢«ä¿å­˜åˆ°äº† pyc æ–‡ä»¶ä¸­ã€‚å½“ä¸‹ä¸€æ¬¡è¿è¡Œç›¸åŒçš„ç¨‹åºæ—¶ï¼ŒPython ä¼šæ ¹æ® pyc æ–‡ä»¶ä¸­è®°å½•çš„ç¼–è¯‘ç»“æœç›´æ¥å»ºç«‹å†…å­˜ä¸­çš„ PyCodeObject å¯¹è±¡ï¼Œè€Œä¸ç”¨å†æ¬¡å¯¹æºæ–‡ä»¶è¿›è¡Œç¼–è¯‘äº†ã€‚
ä»æ–‡ç« æ‘˜å½•å¯è§ï¼Œpython ç”Ÿæˆçš„ä¸æ˜¯ç¼–è¯‘åçš„æ–‡ä»¶ï¼Œè€Œæ˜¯.pyæ–‡ä»¶å¯¹åº”çš„é™æ€ä¿¡æ¯â€”â€”PyCodeObjectï¼Œè¿™é‡ŒåŒ…æ‹¬äº†å­—èŠ‚ç æŒ‡ä»¤åºåˆ—ã€å­—ç¬¦ä¸²ã€å¸¸é‡ã€‚æ¯ä¸ªåå­—ç©ºé—´(ç±»ã€æ¨¡å—ã€å‡½æ•°)éƒ½å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ PyCodeObjectã€‚(python è¿ç¼–è¯‘åçš„æ–‡ä»¶é‡Œå­˜çš„éƒ½æ˜¯ä¸ªå¯¹è±¡ï¼)
ä¸è¢« import çš„ py æ–‡ä»¶ä¸ä¼šç”Ÿæˆ pycã€‚æ ‡å‡†åº“é‡Œæœ‰ py_compile ç­‰æ–¹æ³•ä¹Ÿå¯ä»¥ç”Ÿæˆ pycã€‚
import æœºåˆ¶ å¯¼å…¥æŸä¸ªæ¨¡å—æ—¶ï¼Œå…ˆæŸ¥æ‰¾å¯¹åº”çš„ pycï¼Œå¦‚æœæ²¡æœ‰ pyc å°±ç”Ÿæˆç„¶å import è¿™ä¸ª pycã€‚(æ‰€ä»¥å®é™…å¯¼å…¥çš„å¹¶ä¸æ˜¯ py æ–‡ä»¶ï¼Œè€Œæ˜¯ py æ–‡ä»¶ç¼–è¯‘åçš„ PyCodeObject)ã€‚
PyFrameObject Python ç¨‹åºè¿è¡Œæ—¶çš„ã€Œæ‰§è¡Œç¯å¢ƒã€ã€‚å‚è€ƒæ“ä½œç³»ç»Ÿæ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ã€‚Python ä¹Ÿæ˜¯å°†å‡½æ•°å¯¹åº”çš„æ‰§è¡Œç¯å¢ƒå°è£…æˆæ ˆå¸§çš„å½¢å¼åŠ è½½è¿›å†…å­˜ã€‚
typedef struct _frame { PyObject_VAR_HEAD struct _frame *f_back; //æ‰§è¡Œç¯å¢ƒé“¾ä¸Šçš„å‰ä¸€ä¸ªframe PyCodeObject *f_code; //PyCodeObjectå¯¹è±¡ PyObject *f_builtins; //builtinåå­—ç©ºé—´ PyObject *f_globals; //globalåå­—ç©ºé—´ PyObject *f_locals; //localåå­—ç©ºé—´ PyObject **f_valuestack; //è¿è¡Œæ—¶æ ˆçš„æ ˆåº•ä½ç½® PyObject **f_stacktop; //è¿è¡Œæ—¶æ ˆçš„æ ˆé¡¶ä½ç½® â€¦â€¦ int f_lasti; //ä¸Šä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤åœ¨f_codeä¸­çš„åç§»ä½ç½® int f_lineno; //å½“å‰å­—èŠ‚ç å¯¹åº”çš„æºä»£ç è¡Œ â€¦â€¦ //åŠ¨æ€å†…å­˜ï¼Œç»´æŠ¤ï¼ˆå±€éƒ¨å˜é‡+cellå¯¹è±¡é›†åˆ+freeå¯¹è±¡é›†åˆ+è¿è¡Œæ—¶æ ˆï¼‰æ‰€éœ€è¦çš„ç©ºé—´ PyObject *f_localsplus[1]; } PyFrameObject; Python æ ‡å‡†åº“çš„sys._getframe()å¯ä»¥åŠ¨æ€çš„åœ¨ç¨‹åºæ‰§è¡Œæ—¶è·å–å½“å‰å†…å­˜ä¸­æ´»è·ƒçš„ PyFrameObject ä¿¡æ¯ã€‚"><meta itemprop=name content="ã€ŠPythonæºç å‰–æã€‹ç¬¬äºŒéƒ¨åˆ†â€”â€”Pythonè™šæ‹ŸæœºåŸºç¡€"><meta itemprop=description content="Python æ‰§è¡Œç¯å¢ƒ åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œè¿™äº›åŒ…å«åœ¨ Python æºä»£ç ä¸­çš„é™æ€ä¿¡æ¯éƒ½ä¼šè¢« Python ç¼–è¯‘å™¨æ”¶é›†èµ·æ¥ï¼Œç¼–è¯‘çš„ç»“æœä¸­åŒ…å«äº†å­—ç¬¦ä¸²ï¼Œå¸¸é‡å€¼ï¼Œå­—èŠ‚ç ç­‰åœ¨æºä»£ç ä¸­å‡ºç°çš„ä¸€åˆ‡æœ‰ç”¨çš„é™æ€ä¿¡æ¯ã€‚åœ¨ Python è¿è¡ŒæœŸé—´ï¼Œè¿™äº›æºæ–‡ä»¶ä¸­æä¾›çš„é™æ€ä¿¡æ¯æœ€ç»ˆä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªè¿è¡Œæ—¶çš„å¯¹è±¡ä¸­ï¼Œå½“ Python è¿è¡Œç»“æŸåï¼Œè¿™ä¸ªè¿è¡Œæ—¶å¯¹è±¡ä¸­æ‰€åŒ…å«çš„ä¿¡æ¯ç”šè‡³è¿˜ä¼šè¢«å­˜å‚¨åœ¨ä¸€ç§æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå¯¹è±¡å’Œæ–‡ä»¶å°±æ˜¯æˆ‘ä»¬è¿™ç« æ¢ç´¢çš„é‡ç‚¹ï¼šPyCodeObject å¯¹è±¡å’Œ pyc æ–‡ä»¶ã€‚
åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œç¼–è¯‘ç»“æœå­˜åœ¨äºå†…å­˜çš„ PyCodeObject å¯¹è±¡ä¸­ï¼›è€Œ Python ç»“æŸè¿è¡Œåï¼Œç¼–è¯‘ç»“æœåˆè¢«ä¿å­˜åˆ°äº† pyc æ–‡ä»¶ä¸­ã€‚å½“ä¸‹ä¸€æ¬¡è¿è¡Œç›¸åŒçš„ç¨‹åºæ—¶ï¼ŒPython ä¼šæ ¹æ® pyc æ–‡ä»¶ä¸­è®°å½•çš„ç¼–è¯‘ç»“æœç›´æ¥å»ºç«‹å†…å­˜ä¸­çš„ PyCodeObject å¯¹è±¡ï¼Œè€Œä¸ç”¨å†æ¬¡å¯¹æºæ–‡ä»¶è¿›è¡Œç¼–è¯‘äº†ã€‚
ä»æ–‡ç« æ‘˜å½•å¯è§ï¼Œpython ç”Ÿæˆçš„ä¸æ˜¯ç¼–è¯‘åçš„æ–‡ä»¶ï¼Œè€Œæ˜¯.pyæ–‡ä»¶å¯¹åº”çš„é™æ€ä¿¡æ¯â€”â€”PyCodeObjectï¼Œè¿™é‡ŒåŒ…æ‹¬äº†å­—èŠ‚ç æŒ‡ä»¤åºåˆ—ã€å­—ç¬¦ä¸²ã€å¸¸é‡ã€‚æ¯ä¸ªåå­—ç©ºé—´(ç±»ã€æ¨¡å—ã€å‡½æ•°)éƒ½å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ PyCodeObjectã€‚(python è¿ç¼–è¯‘åçš„æ–‡ä»¶é‡Œå­˜çš„éƒ½æ˜¯ä¸ªå¯¹è±¡ï¼)
ä¸è¢« import çš„ py æ–‡ä»¶ä¸ä¼šç”Ÿæˆ pycã€‚æ ‡å‡†åº“é‡Œæœ‰ py_compile ç­‰æ–¹æ³•ä¹Ÿå¯ä»¥ç”Ÿæˆ pycã€‚
import æœºåˆ¶ å¯¼å…¥æŸä¸ªæ¨¡å—æ—¶ï¼Œå…ˆæŸ¥æ‰¾å¯¹åº”çš„ pycï¼Œå¦‚æœæ²¡æœ‰ pyc å°±ç”Ÿæˆç„¶å import è¿™ä¸ª pycã€‚(æ‰€ä»¥å®é™…å¯¼å…¥çš„å¹¶ä¸æ˜¯ py æ–‡ä»¶ï¼Œè€Œæ˜¯ py æ–‡ä»¶ç¼–è¯‘åçš„ PyCodeObject)ã€‚
PyFrameObject Python ç¨‹åºè¿è¡Œæ—¶çš„ã€Œæ‰§è¡Œç¯å¢ƒã€ã€‚å‚è€ƒæ“ä½œç³»ç»Ÿæ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ã€‚Python ä¹Ÿæ˜¯å°†å‡½æ•°å¯¹åº”çš„æ‰§è¡Œç¯å¢ƒå°è£…æˆæ ˆå¸§çš„å½¢å¼åŠ è½½è¿›å†…å­˜ã€‚
typedef struct _frame { PyObject_VAR_HEAD struct _frame *f_back; //æ‰§è¡Œç¯å¢ƒé“¾ä¸Šçš„å‰ä¸€ä¸ªframe PyCodeObject *f_code; //PyCodeObjectå¯¹è±¡ PyObject *f_builtins; //builtinåå­—ç©ºé—´ PyObject *f_globals; //globalåå­—ç©ºé—´ PyObject *f_locals; //localåå­—ç©ºé—´ PyObject **f_valuestack; //è¿è¡Œæ—¶æ ˆçš„æ ˆåº•ä½ç½® PyObject **f_stacktop; //è¿è¡Œæ—¶æ ˆçš„æ ˆé¡¶ä½ç½® â€¦â€¦ int f_lasti; //ä¸Šä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤åœ¨f_codeä¸­çš„åç§»ä½ç½® int f_lineno; //å½“å‰å­—èŠ‚ç å¯¹åº”çš„æºä»£ç è¡Œ â€¦â€¦ //åŠ¨æ€å†…å­˜ï¼Œç»´æŠ¤ï¼ˆå±€éƒ¨å˜é‡+cellå¯¹è±¡é›†åˆ+freeå¯¹è±¡é›†åˆ+è¿è¡Œæ—¶æ ˆï¼‰æ‰€éœ€è¦çš„ç©ºé—´ PyObject *f_localsplus[1]; } PyFrameObject; Python æ ‡å‡†åº“çš„sys._getframe()å¯ä»¥åŠ¨æ€çš„åœ¨ç¨‹åºæ‰§è¡Œæ—¶è·å–å½“å‰å†…å­˜ä¸­æ´»è·ƒçš„ PyFrameObject ä¿¡æ¯ã€‚"><meta itemprop=datePublished content="2017-07-13T00:00:00+00:00"><meta itemprop=dateModified content="2017-07-13T00:00:00+00:00"><meta itemprop=wordCount content="435"><meta itemprop=image content="https://sund.site/images/share.png"><meta itemprop=keywords content="Python"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width-max:720px;--font-primary:Verdana, sans-serif;--font-secondary:monospace;--font-size-primary:1em;--font-size-secondary:0.8em;--body-bg-color:#fcfcfc;--bold-text-color:#222;--body-text-color:#444;--link-color:#3273dc;--link-visited-color:#8b6fcb;--table-border-color:#f2f2f2;--table-th-bg-color:#f2f2f2;--img-border-color:#f2f2f2;--code-bg-color:#f2f2f2;--code-text-color:#222;--blockquote-border-color:#666;--blockquote-text-color:#666;--upvoted-color:#FA8072}@media(prefers-color-scheme:dark){:root{--body-bg-color:#1c1c1c;--bold-text-color:#eee;--body-text-color:#ddd;--link-color:#8cc2dd;--link-visited-color:#c3b1ee;--table-border-color:#999;--table-th-bg-color:#999;--img-border-color:#999;--code-bg-color:#555;--code-text-color:#ddd;--blockquote-border-color:#ccc;--blockquote-text-color:#ccc}}body{font-family:var(--font-primary);font-size:var(--font-size-primary);margin:auto;padding:20px;max-width:var(--width-max);text-align:left;background-color:var(--body-bg-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--body-text-color)}h1,h2,h3,h4,h5,h6,strong,b{color:var(--bold-text-color)}h1,h2,h3,h4,h5,h6{margin:16px 0}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}.title{text-decoration:none;border:0}.title:hover{text-decoration:none}.title span{font-weight:400}nav a{margin-right:8px}textarea{width:100%;font-size:16px}input{font-size:14px}content{line-height:1.6}table{width:100%;border-collapse:collapse;border:1px solid var(--table-border-color);border-radius:4px}th,td{border:1px solid var(--table-border-color);padding:4px}th{background-color:var(--table-th-bg-color)}hr{border:0;border-top:1px dashed}img{max-width:100%;display:block;margin-left:auto;margin-right:auto;border:1px solid var(--img-border-color);border-radius:4px;content-visibility:auto;loading:lazy}img[src*="#minipic"]{max-width:50%;margin-left:0;margin-right:auto}i{font-style:normal}time{font-family:var(--font-secondary);font-size:15px}code{font-family:var(--font-secondary);background-color:var(--code-bg-color);color:var(--code-text-color);padding:2px;border-radius:4px}pre code{display:block;padding:16px;white-space:pre-wrap;overflow-x:auto}div.highlight pre{border-radius:4px}div.highlight code{background-color:var(--code-bg-color);color:var(--code-text-color)}blockquote{border-left:2px solid var(--blockquote-border-color);color:var(--blockquote-text-color);margin:0;padding-left:16px;font-style:normal}blockquote p{margin:0}footer{padding:25px 0;text-align:center;font-size:var(--font-size-secondary)}ul li:has(input){list-style-type:none;margin-left:-25.5px}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li span.grouped{flex:0 0 80px}ul.blog-posts li a:visited{color:var(--link-visited-color)}div.toc{position:fixed;top:50%;left:calc((100vw + var(--width-max))/2);transform:translateY(-50%);width:calc((90vw - var(--width-max))/2);max-height:80vh;overflow-y:auto;padding:20px 8px;z-index:99;&::-webkit-scrollbar { display:none; } -ms-overflow-style:none;scrollbar-width:none}div.toc ul{list-style-type:none;padding-left:0}div.toc ul li{margin:8px 0}div.toc ul li a{text-decoration:none;color:var(--blockquote-text-color)}div.toc ul li a:hover{color:var(--link-color)}button.upvote-btn{margin:0;padding:0;border:none;background:0 0;cursor:pointer;display:flex;flex-direction:column;align-items:center;color:var(--body-text-color)}button.upvoted{color:var(--upvoted-color)}span.upvote-count{margin-top:-4px;font-size:smaller}@media(max-width:500px){img[src*="#minipic"]{max-width:100%;margin-left:auto;margin-right:auto}div.toc{display:none}}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-XJJVVQ0LBH"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XJJVVQ0LBH")</script></head><body><header><a href=/ class=title><h1>Steve Sun</h1></a><nav><a href=/>Home</a>
<a href=/friends/>Friends</a>
<a href=/posts/>Posts</a></nav></header><main><content><h2 id=python-æ‰§è¡Œç¯å¢ƒ>Python æ‰§è¡Œç¯å¢ƒ</h2><blockquote><p>åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œè¿™äº›åŒ…å«åœ¨ Python æºä»£ç ä¸­çš„é™æ€ä¿¡æ¯éƒ½ä¼šè¢« Python ç¼–è¯‘å™¨æ”¶é›†èµ·æ¥ï¼Œç¼–è¯‘çš„ç»“æœä¸­åŒ…å«äº†å­—ç¬¦ä¸²ï¼Œå¸¸é‡å€¼ï¼Œå­—èŠ‚ç ç­‰åœ¨æºä»£ç ä¸­å‡ºç°çš„ä¸€åˆ‡æœ‰ç”¨çš„é™æ€ä¿¡æ¯ã€‚åœ¨ Python è¿è¡ŒæœŸé—´ï¼Œè¿™äº›æºæ–‡ä»¶ä¸­æä¾›çš„é™æ€ä¿¡æ¯æœ€ç»ˆä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªè¿è¡Œæ—¶çš„å¯¹è±¡ä¸­ï¼Œå½“ Python è¿è¡Œç»“æŸåï¼Œè¿™ä¸ªè¿è¡Œæ—¶å¯¹è±¡ä¸­æ‰€åŒ…å«çš„ä¿¡æ¯ç”šè‡³è¿˜ä¼šè¢«å­˜å‚¨åœ¨ä¸€ç§æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå¯¹è±¡å’Œæ–‡ä»¶å°±æ˜¯æˆ‘ä»¬è¿™ç« æ¢ç´¢çš„é‡ç‚¹ï¼šPyCodeObject å¯¹è±¡å’Œ pyc æ–‡ä»¶ã€‚</p></blockquote><blockquote><p>åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œç¼–è¯‘ç»“æœå­˜åœ¨äºå†…å­˜çš„ PyCodeObject å¯¹è±¡ä¸­ï¼›è€Œ Python ç»“æŸè¿è¡Œåï¼Œç¼–è¯‘ç»“æœåˆè¢«ä¿å­˜åˆ°äº† pyc æ–‡ä»¶ä¸­ã€‚å½“ä¸‹ä¸€æ¬¡è¿è¡Œç›¸åŒçš„ç¨‹åºæ—¶ï¼ŒPython ä¼šæ ¹æ® pyc æ–‡ä»¶ä¸­è®°å½•çš„ç¼–è¯‘ç»“æœç›´æ¥å»ºç«‹å†…å­˜ä¸­çš„ PyCodeObject å¯¹è±¡ï¼Œè€Œä¸ç”¨å†æ¬¡å¯¹æºæ–‡ä»¶è¿›è¡Œç¼–è¯‘äº†ã€‚</p></blockquote><p>ä»æ–‡ç« æ‘˜å½•å¯è§ï¼Œpython ç”Ÿæˆçš„ä¸æ˜¯ç¼–è¯‘åçš„æ–‡ä»¶ï¼Œè€Œæ˜¯<code>.py</code>æ–‡ä»¶å¯¹åº”çš„é™æ€ä¿¡æ¯â€”â€”PyCodeObjectï¼Œè¿™é‡ŒåŒ…æ‹¬äº†å­—èŠ‚ç æŒ‡ä»¤åºåˆ—ã€å­—ç¬¦ä¸²ã€å¸¸é‡ã€‚æ¯ä¸ªåå­—ç©ºé—´(ç±»ã€æ¨¡å—ã€å‡½æ•°)éƒ½å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ PyCodeObjectã€‚(python è¿ç¼–è¯‘åçš„æ–‡ä»¶é‡Œå­˜çš„éƒ½æ˜¯ä¸ªå¯¹è±¡ï¼)</p><p>ä¸è¢« import çš„ py æ–‡ä»¶ä¸ä¼šç”Ÿæˆ pycã€‚æ ‡å‡†åº“é‡Œæœ‰ py_compile ç­‰æ–¹æ³•ä¹Ÿå¯ä»¥ç”Ÿæˆ pycã€‚</p><p><strong>import æœºåˆ¶</strong> å¯¼å…¥æŸä¸ªæ¨¡å—æ—¶ï¼Œå…ˆæŸ¥æ‰¾å¯¹åº”çš„ pycï¼Œå¦‚æœæ²¡æœ‰ pyc å°±ç”Ÿæˆç„¶å import è¿™ä¸ª pycã€‚(æ‰€ä»¥å®é™…å¯¼å…¥çš„å¹¶ä¸æ˜¯ py æ–‡ä»¶ï¼Œè€Œæ˜¯ py æ–‡ä»¶ç¼–è¯‘åçš„ PyCodeObject)ã€‚</p><p><strong>PyFrameObject</strong> Python ç¨‹åºè¿è¡Œæ—¶çš„ã€Œæ‰§è¡Œç¯å¢ƒã€ã€‚å‚è€ƒæ“ä½œç³»ç»Ÿæ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ã€‚Python ä¹Ÿæ˜¯å°†å‡½æ•°å¯¹åº”çš„æ‰§è¡Œç¯å¢ƒå°è£…æˆæ ˆå¸§çš„å½¢å¼åŠ è½½è¿›å†…å­˜ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _frame {
</span></span><span style=display:flex><span>    PyObject_VAR_HEAD
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> _frame <span style=color:#f92672>*</span>f_back;  <span style=color:#75715e>//æ‰§è¡Œç¯å¢ƒé“¾ä¸Šçš„å‰ä¸€ä¸ªframe
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    PyCodeObject <span style=color:#f92672>*</span>f_code;   <span style=color:#75715e>//PyCodeObjectå¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    PyObject <span style=color:#f92672>*</span>f_builtins;   <span style=color:#75715e>//builtinåå­—ç©ºé—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    PyObject <span style=color:#f92672>*</span>f_globals;    <span style=color:#75715e>//globalåå­—ç©ºé—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    PyObject <span style=color:#f92672>*</span>f_locals;     <span style=color:#75715e>//localåå­—ç©ºé—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    PyObject <span style=color:#f92672>**</span>f_valuestack;    <span style=color:#75715e>//è¿è¡Œæ—¶æ ˆçš„æ ˆåº•ä½ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    PyObject <span style=color:#f92672>**</span>f_stacktop;      <span style=color:#75715e>//è¿è¡Œæ—¶æ ˆçš„æ ˆé¡¶ä½ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#960050;background-color:#1e0010>â€¦â€¦</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> f_lasti;        <span style=color:#75715e>//ä¸Šä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤åœ¨f_codeä¸­çš„åç§»ä½ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> f_lineno;       <span style=color:#75715e>//å½“å‰å­—èŠ‚ç å¯¹åº”çš„æºä»£ç è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#960050;background-color:#1e0010>â€¦â€¦</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//åŠ¨æ€å†…å­˜ï¼Œç»´æŠ¤ï¼ˆå±€éƒ¨å˜é‡+cellå¯¹è±¡é›†åˆ+freeå¯¹è±¡é›†åˆ+è¿è¡Œæ—¶æ ˆï¼‰æ‰€éœ€è¦çš„ç©ºé—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    PyObject <span style=color:#f92672>*</span>f_localsplus[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>} PyFrameObject;
</span></span></code></pre></div><p>Python æ ‡å‡†åº“çš„<code>sys._getframe()</code>å¯ä»¥åŠ¨æ€çš„åœ¨ç¨‹åºæ‰§è¡Œæ—¶è·å–å½“å‰å†…å­˜ä¸­æ´»è·ƒçš„ PyFrameObject ä¿¡æ¯ã€‚</p><h2 id=legb-è§„åˆ™>LEGB è§„åˆ™</h2><p>å³ python ä½œç”¨åŸŸçš„æŸ¥æ‰¾é¡ºåºæ˜¯<code>local</code>-<code>enclosing</code>-<code>global</code>-<code>buildin</code>ã€‚çœ‹ä¸‹é¢ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>a <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>g</span>():
</span></span><span style=display:flex><span>  print a
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f</span>():
</span></span><span style=display:flex><span>  print a <span style=color:#f92672>//</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>  a <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>//</span>[<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>  print a
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>g()
</span></span></code></pre></div><p>ä»£ç åœ¨[1]å¤„ä¼šæŠ›å‡ºå¼‚å¸¸ï¼ŒåŸå› æ˜¯ python åœ¨ç¼–è¯‘é˜¶æ®µå°±æŠŠé™æ€æ•°æ®(å±€éƒ¨å˜é‡ã€å…¨å±€å˜é‡ã€å­—èŠ‚ç )æ”¾å…¥ pyc é‡Œï¼Œæ‰§è¡Œåˆ°<code>f()</code>é‡Œæ—¶ï¼ŒæŸ¥æ‰¾åˆ°<code>a</code>æ˜¯åœ¨ local ä½œç”¨åŸŸé‡Œå®šä¹‰çš„è€Œä¸æ˜¯ global é‡Œï¼Œä½†æ˜¯æ­¤æ—¶ local çš„ a è¿˜æ²¡èµ‹å€¼ï¼Œæ‰€ä»¥å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ç”±æ­¤å¯è§ï¼Œ<strong>python ä½œç”¨åŸŸä¿¡æ¯æ˜¯åœ¨é™æ€ç¼–è¯‘æ—¶å°±å¤„ç†å¥½äº†çš„</strong>ã€‚</p><h2 id=python-è™šæ‹Ÿæœºè¿è¡Œæ¡†æ¶>Python è™šæ‹Ÿæœºè¿è¡Œæ¡†æ¶</h2><blockquote><p>è¿è¡Œæ—¶ç¯å¢ƒæ˜¯ä¸€ä¸ªå…¨å±€çš„æ¦‚å¿µï¼Œè€Œæ‰§è¡Œç¯å¢ƒå®é™…å°±æ˜¯ä¸€ä¸ªæ ˆå¸§ï¼Œæ˜¯ä¸€ä¸ªä¸æŸä¸ª Code Block å¯¹åº”çš„æ¦‚å¿µã€‚</p></blockquote><blockquote><p>åœ¨ PyCodeObject å¯¹è±¡çš„ co_code åŸŸä¸­ä¿å­˜ç€å­—èŠ‚ç æŒ‡ä»¤å’Œå­—èŠ‚ç æŒ‡ä»¤çš„å‚æ•°ï¼ŒPython è™šæ‹Ÿæœºæ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤åºåˆ—çš„è¿‡ç¨‹å°±æ˜¯ä»å¤´åˆ°å°¾éå†æ•´ä¸ª co_codeã€ä¾æ¬¡æ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤çš„è¿‡ç¨‹ã€‚</p></blockquote><p>ç”±ä¸Šæ–‡å¼•ç”¨å¯è§ï¼Œpython åœ¨ç¼–è¯‘é˜¶æ®µå°†ä»£ç å—çš„å­—èŠ‚ç ä¿å­˜åœ¨ PyCodeObject çš„ co_code å±æ€§é‡Œï¼Œç„¶ååœ¨æ‰§è¡Œé˜¶æ®µä»å¤´åˆ°å°¾éå†è¿™ä¸ª co_code å±æ€§è§£è¯»å­—èŠ‚ç ã€‚</p><p><strong>Python è¿è¡Œæ—¶ç¯å¢ƒ</strong> Python åœ¨è¿è¡Œæ—¶ç”¨ PyInterpreterState ç»“æ„ç»´æŠ¤è¿›ç¨‹è¿è¡Œç¯å¢ƒï¼ŒPyThreadState ç»´æŠ¤çº¿ç¨‹è¿è¡Œç¯å¢ƒï¼ŒPyFrameObject ç»´æŠ¤æ ˆå¸§è¿è¡Œç¯å¢ƒï¼Œä¸‰è€…æ˜¯ä¾æ¬¡åŒ…å«å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=https://i.loli.net/2021/03/05/GHImB214fvxSXgk.png alt></p><p>Python è™šæ‹Ÿæœºå°±æ˜¯ä¸€ä¸ªã€Œè½¯ CPUã€ï¼ŒåŠ¨æ€åŠ è½½ä¸Šè¿°ä¸‰ç§ç»“æ„è¿›å†…å­˜ï¼Œå¹¶æ¨¡æ‹Ÿæ“ä½œç³»ç»Ÿæ‰§è¡Œè¿‡ç¨‹ã€‚ç¨‹åºæ‰§è¡Œåï¼Œå…ˆåˆ›å»ºå„ä¸ªè¿è¡Œæ—¶ç¯å¢ƒï¼Œå†å°†æ ˆå¸§ä¸­çš„å­—èŠ‚ç è½½å…¥ï¼Œå¾ªç¯éå†è§£é‡Šæ‰§è¡Œã€‚</p><h2 id=python-å­—èŠ‚ç >Python å­—èŠ‚ç </h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>   LOAD_CONST   <span style=color:#ae81ff>0</span>  (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>   STORE_NAME   <span style=color:#ae81ff>0</span>  (i)
</span></span></code></pre></div><p>ä¾‹å¦‚ python çš„ä¸€æ¡è¯­å¥<code>i=1</code>å¯ä»¥è§£é‡Šä¸ºä¸‹é¢ä¸¤è¡Œå­—èŠ‚ç ï¼Œæœ€å·¦è¾¹çš„ç¬¬ 1 åˆ—æ•°å­—ä»£è¡¨è¿™è¡Œå­—èŠ‚ç åœ¨å†…å­˜ä¸­çš„åç§»ä½ç½®ï¼Œç¬¬ 2 åˆ—æ˜¯å­—èŠ‚ç çš„åå­—(CPU å¹¶ä¸å…³å¿ƒåå­—ï¼Œå®ƒåªæ˜¯æ ¹æ®åç§»é‡è¯»å‡ºå­—èŠ‚ç ï¼Œæ‰€ä»¥è¿™ä¸ªåå­—æ˜¯æ–¹ä¾¿é˜…è¯»ç”¨çš„)ï¼Œç¬¬ 3 åˆ—æ˜¯å­—èŠ‚ç çš„å‚æ•°ï¼Œå¦‚<code>LOAD_CONST</code>å¯¹åº”çš„æ•°æ®åœ¨å˜é‡<code>f->f_code->co_consts</code>é‡Œï¼Œ0 å°±æ˜¯è¿™ä¸ªå‚æ•°ä½äº<code>f->f_code->co_consts</code>çš„åç§»é‡ã€‚æœ€åä¸€åˆ—çš„æ‹¬å·é‡Œæ˜¯ä»å‚æ•°é‡Œå–åˆ°çš„ valueã€‚</p><h2 id=python-çš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶>Python çš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶</h2><p>å¼‚å¸¸å¤„ç†çš„æ“ä½œéƒ½åœ¨<code>Python/traceback.c</code>æ–‡ä»¶é‡Œï¼Œpython æ¯æ¬¡è°ƒç”¨ä¸€å±‚å‡½æ•°ï¼Œå°±åˆ›å»ºæ”¹å‡½æ•°å¯¹åº”çš„ PyFrameObject å¯¹è±¡æ¥ä¿å­˜å‡½æ•°è¿è¡Œæ—¶ä¿¡æ¯ï¼ŒPythonFrameObject é‡Œè°ƒç”¨ PyEval_EvalFrameEx å¾ªç¯è§£é‡Šå­—èŠ‚ç ï¼Œå¦‚æœæŠ›å‡ºå¼‚å¸¸å°±åˆ›å»º PyTraceBackObject å¯¹è±¡ï¼Œå°†å¯¹è±¡äº¤ç»™ä¸Šä¸€å±‚ PyFrameObject é‡Œçš„ PyTracebackObject ç»„æˆé“¾è¡¨ï¼Œæœ€åè¿”å›æœ€ä¸Šå±‚ PyRun_SimpleFileExFlags å‡½æ•°ï¼Œè¯¥å‡½æ•°è°ƒç”¨ PyErr_Print éå† PyTraceBackObject é“¾è¡¨æ‰“å°å‡ºå¼‚å¸¸ä¿¡æ¯ã€‚</p><p><img src=https://i.loli.net/2021/03/05/9bEUBjYov8mZy3s.jpg alt></p><h2 id=å‡½æ•°å¯¹è±¡çš„å®ç°>å‡½æ•°å¯¹è±¡çš„å®ç°</h2><p>PyFunctionObject æ˜¯å‡½æ•°å¯¹è±¡ã€‚åœ¨ python è°ƒç”¨å‡½æ•°æ—¶ï¼Œç”Ÿæˆ PyFunctionObject å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„ f_global æŒ‡é’ˆç”¨æ¥å°†å¤–å±‚çš„å…¨å±€å˜é‡ä¼ é€’ç»™å‡½æ•°å†…éƒ¨ï¼Œç„¶ååœ¨<code>ceval.c</code>æ–‡ä»¶çš„<code>fast_function</code>é‡Œè§£å‡º PyFunctionObject å¯¹è±¡é‡Œæºå¸¦çš„ä¿¡æ¯ï¼Œåˆ›å»ºæ–°çš„ PyFrameObject å¯¹è±¡(ä¸Šæ–‡è¯´è¿‡è¿™ä¸ªå¯¹è±¡æ˜¯ç»´æŠ¤è¿è¡Œæ—¶ç¯å¢ƒçš„)ï¼Œæœ€åè°ƒç”¨æ‰§è¡Œå­—èŠ‚ç çš„å‡½æ•°<code>PyEval_EvalFrameEx</code>æ‰§è¡ŒçœŸæ­£å‡½æ•°å­—èŠ‚ç ã€‚</p><p><strong>Python æ‰§è¡Œä¸€æ®µä»£ç éœ€è¦ä»€ä¹ˆï¼Ÿ</strong> ä»ä¹¦ä¸­æè¿°å¯è§ï¼Œpython æ‰§è¡Œä¸€æ®µä»£ç éœ€è¦åšå‡ ä»¶äº‹ï¼š</p><ul><li>ä»æºç ç¼–è¯‘å‡º PyCodeObject ä¿å­˜å˜é‡å’Œå­—èŠ‚ç </li><li>æ‰§è¡Œé˜¶æ®µï¼Œä» PyCodeObject é‡Œå–å‡ºä¿¡æ¯äº¤ç»™ PyFrameObjectï¼Œæ‰§è¡Œ PyEval_EvalFrameEx è§£é‡Šå­—èŠ‚ç </li><li>å¦‚æœé‡åˆ°å‡½æ•°è°ƒç”¨ï¼Œå°±æŠŠå‡½æ•°å¯¹åº”çš„ä»£ç æ®µä» PyCodeObject å­˜å…¥ PyFunctionObject å¯¹è±¡ï¼Œç„¶åæŠŠè¿™ä¸ªå‡½æ•°å¯¹è±¡é€šè¿‡å‚æ•°ä¼ ç»™æ–°åˆ›å»ºçš„ PyFrameObject ï¼Œåœ¨å†…å±‚ç©ºé—´æ‰§è¡Œ PyEval_EvalFrameEx è§£é‡Šå­—èŠ‚ç </li><li>å°†ç»“æœæˆ–å¼‚å¸¸å­˜å…¥ PyFrameObject çš„å˜é‡( å¼‚å¸¸æ˜¯å­˜å…¥ f_blockstack é‡Œï¼Œå¤–å±‚åˆ¤æ–­ f_blockstack é‡Œçš„æ•°æ®æ˜¯è¢« except æ•è·è¿˜æ˜¯æ²¡æœ‰æ•è·è€Œç»§ç»­ä¸‹ä¸€æ­¥æ“ä½œ) æŠ›ç»™å¤–å±‚</li></ul><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<strong>python åœ¨æ‰§è¡Œé˜¶æ®µï¼Œå°†å¯¹å‡½æ•°å‚æ•°çš„é”®å€¼æŸ¥æ‰¾ï¼Œè½¬æ¢ä¸ºç´¢å¼•æŸ¥æ‰¾</strong>ï¼Œå³åœ¨è½¬æ¢ PyCodeObject ä¸º PyFrameObject æ—¶ï¼Œå°†å‚æ•°ä¿¡æ¯æŒ‰ä½ç½®å‚æ•°ã€é”®å‚æ•°æŒ‰ç…§ä¸€å®šé¡ºåºå­˜å‚¨åœ¨ f_localsplus å˜é‡ä¸­ï¼Œå†ç”¨ç´¢å¼•æ¥æŸ¥æ‰¾å¯¹åº”å‚æ•°ï¼Œè€Œéœ€è¦æŸ¥æ‰¾é”®å€¼ã€‚è¿™æ ·æé«˜äº†è¿è¡Œæ—¶æ•ˆç‡ã€‚ä¸‹å›¾æ˜¯<code>foo('Rboert', age=5)</code>åœ¨å†…å­˜ä¸­çš„å­˜å‚¨å½¢å¼ã€‚</p><p><img src=https://i.loli.net/2021/03/05/IGy8JTzZpgmN6sL.jpg alt></p><h2 id=é—­åŒ…çš„å®ç°>é—­åŒ…çš„å®ç°</h2><p>Python åœ¨ç¼–è¯‘é˜¶æ®µå°±æŠŠå‡½æ•°é—­åŒ…å†…å±‚å’Œé—­åŒ…å¤–å±‚ä½¿ç”¨çš„å˜é‡å­˜å…¥ PyCodeObject ä¸­ï¼š</p><ul><li>co_cellvarsï¼šé€šå¸¸æ˜¯ä¸€ä¸ª tupleï¼Œä¿å­˜åµŒå¥—çš„ä½œç”¨åŸŸä¸­ä½¿ç”¨çš„å˜é‡åé›†åˆï¼›</li><li>co_freevarsï¼šé€šå¸¸ä¹Ÿæ˜¯ä¸€ä¸ª tupleï¼Œä¿å­˜ä½¿ç”¨äº†çš„å¤–å±‚ä½œç”¨åŸŸä¸­çš„å˜é‡åé›†åˆã€‚</li></ul><p>åœ¨æ‰§è¡Œé˜¶æ®µï¼ŒPyFrameObject çš„ f_localsplus ä¸­ä¹Ÿä¸ºé—­åŒ…çš„å˜é‡åˆ’åˆ†çš„å†…å­˜åŒºåŸŸï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=https://i.loli.net/2021/03/05/fUB4wC36dAc7rqt.jpg alt></p><h2 id=å…ƒç±»>å…ƒç±»</h2><p>å…ƒç±»<code>&lt;type type></code>å’Œå…¶ä»–ç±»çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src=https://i.loli.net/2021/03/05/N76woqSlmR28Oyt.jpg alt></p><p><strong>å¯è°ƒç”¨æ€§ï¼ˆcallableï¼‰</strong> ï¼Œåªè¦ä¸€ä¸ªå¯¹è±¡å¯¹åº”çš„ class å¯¹è±¡ä¸­å®ç°äº†â€œ<strong>call</strong>â€æ“ä½œï¼ˆæ›´ç¡®åˆ‡åœ°è¯´ï¼Œåœ¨ Python å†…éƒ¨çš„ PyTypeObject ä¸­ï¼Œtp_call ä¸ä¸ºç©ºï¼‰é‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯ä¸€ä¸ªå¯è°ƒç”¨çš„å¯¹è±¡ï¼Œæ¢å¥è¯è¯´ï¼Œåœ¨ Python ä¸­ï¼Œæ‰€è°“â€œè°ƒç”¨â€ï¼Œå°±æ˜¯æ‰§è¡Œå¯¹è±¡çš„ type æ‰€å¯¹åº”çš„ class å¯¹è±¡çš„ tp_call æ“ä½œã€‚</p><h2 id=descriptor>Descriptor</h2><blockquote><p>åœ¨ PyType_Ready ä¸­ï¼ŒPython è™šæ‹Ÿæœºä¼šå¡«å…… tp_dictï¼Œå…¶ä¸­ä¸æ“ä½œåå¯¹åº”çš„æ˜¯ä¸€ä¸ªä¸ª descriptor
å¯¹äºä¸€ä¸ª Python ä¸­çš„å¯¹è±¡ objï¼Œå¦‚æœ obj.<strong>class</strong>å¯¹åº”çš„ class å¯¹è±¡ä¸­å­˜åœ¨<strong>get</strong>ã€<strong>set</strong>å’Œ<strong>delete</strong>ä¸‰ç§æ“ä½œï¼Œé‚£ä¹ˆ obj å°±å¯ç§°ä¸º Python ä¸€ä¸ª descriptorã€‚</p></blockquote><blockquote><p>å¦‚æœç»†åˆ†ï¼Œé‚£ä¹ˆ descriptor è¿˜å¯åˆ†ä¸ºå¦‚ä¸‹ä¸¤ç§ï¼š</p></blockquote><ol><li>data descriptor : type ä¸­å®šä¹‰äº†<strong>get</strong>å’Œ<strong>set</strong>çš„ descriptorï¼›</li><li>non data descriptor : type ä¸­åªå®šä¹‰äº†<strong>get</strong>çš„ descriptorã€‚
åœ¨ Python è™šæ‹Ÿæœºè®¿é—® instance å¯¹è±¡çš„å±æ€§æ—¶ï¼Œdescriptor çš„ä¸€ä¸ªä½œç”¨æ˜¯å½±å“ Python è™šæ‹Ÿæœºå¯¹å±æ€§çš„é€‰æ‹©ã€‚ä» PyObject_GenericGetAttr çš„ä¼ªä»£ç å¯ä»¥çœ‹å‡ºï¼ŒPython è™šæ‹Ÿæœºä¼šåœ¨ instance å¯¹è±¡è‡ªèº«çš„<strong>dict</strong>ä¸­å¯»æ‰¾å±æ€§ï¼Œä¹Ÿä¼šåœ¨ instance å¯¹è±¡å¯¹åº”çš„ class å¯¹è±¡çš„ mro åˆ—è¡¨ä¸­å¯»æ‰¾</li></ol><blockquote><ol><li>Python è™šæ‹ŸæœºæŒ‰ç…§ instance å±æ€§ã€class å±æ€§çš„é¡ºåºé€‰æ‹©å±æ€§ï¼Œå³ instance å±æ€§ä¼˜å…ˆäº class å±æ€§ï¼›</li><li>å¦‚æœåœ¨ class å±æ€§ä¸­å‘ç°åŒåçš„ data descriptorï¼Œé‚£ä¹ˆè¯¥ descriptor ä¼šä¼˜å…ˆäº instance å±æ€§è¢« Python è™šæ‹Ÿæœºé€‰æ‹©</li></ol></blockquote><p><img src=https://i.loli.net/2021/03/05/1xKk3IVPdjWb8iB.jpg alt></p><h3 id=å¼•ç”³python-é»‘é­”æ³•-descriptor-æè¿°å™¨>å¼•ç”³ï¼šPython é»‘é­”æ³• Descriptor (æè¿°å™¨)</h3><ul><li><a href=http://www.jianshu.com/p/250f0d305c35>http://www.jianshu.com/p/250f0d305c35</a></li><li><a href=http://pyzh.readthedocs.io/en/latest/Descriptor-HOW-TO-Guide.html>http://pyzh.readthedocs.io/en/latest/Descriptor-HOW-TO-Guide.html</a></li></ul><h2 id=bound-method-å’Œ-unbound-method>Bound Method å’Œ Unbound Method</h2><p>å‡è®¾æœ‰ä¸‹é¢ä¸¤ç§å¯¹ç±»æ–¹æ³•çš„è°ƒç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>A</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> A()
</span></span><span style=display:flex><span><span style=color:#75715e># [1]</span>
</span></span><span style=display:flex><span>a<span style=color:#f92672>.</span>f()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># [2]</span>
</span></span><span style=display:flex><span>A<span style=color:#f92672>.</span>f(a)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># [3]</span>
</span></span><span style=display:flex><span>func <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span>f
</span></span><span style=display:flex><span>func()
</span></span></code></pre></div><p>åœ¨ä»£ç [1]é‡Œï¼Œå®ä¾‹ a è°ƒç”¨ç±»æ–¹æ³• fï¼Œpython åº•å±‚ä¼šè‡ªåŠ¨å®Œæˆå®ä¾‹ a å’Œç±»æ–¹æ³• f ä¹‹é—´çš„ç»‘å®šåŠ¨ä½œ(è°ƒç”¨<code>func_ descr_get(A.f, a, A)</code>ï¼Œå°†å®ä¾‹åœ°å€å’Œå‡½æ•°å¯¹è±¡ PyFunctionObject å°è£…åˆ°ä¸€ä¸ª PyMethodObject)ï¼Œè€Œä»£ç [2]é‡Œç›´æ¥é€šè¿‡ A è°ƒç”¨ï¼Œåˆ™ f ä¸ºéç»‘å®šçš„ PyMethodObjectï¼Œé‡Œé¢æ²¡æœ‰å®ä¾‹ä¿¡æ¯ï¼Œéœ€è¦ä¼ å…¥ aã€‚</p><p>æ¯”è¾ƒç»‘å®šæ–¹æ³•ä¸éç»‘å®šæ–¹æ³•å¯çŸ¥ï¼Œé€šè¿‡[1]çš„æ–¹å¼æ¯æ¬¡éƒ½è¦ç»‘å®šä¸€æ¬¡å®ä¾‹ï¼Œå¼€é”€éå¸¸å¤§ï¼Œä¸‹å›¾æ¯”è¾ƒçš„æ˜¯[1]å’Œ[3]ä¸¤ç§æ–¹å¼ï¼Œç»‘å®šæ“ä½œçš„æ‰§è¡Œæ¬¡æ•°ã€‚</p><p><img src=https://i.loli.net/2021/03/05/TpCcdaYmHlQnXzE.jpg alt></p><p>ç»“è®ºï¼š <strong>è°ƒç”¨ç±»å®ä¾‹ç»‘å®šçš„æ–¹æ³•æ—¶ï¼Œå¦‚æœæ–¹æ³•æ‰§è¡Œæ¬¡æ•°éå¸¸å¤šï¼Œæœ€å¥½å°†æ–¹æ³•èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œé˜²æ­¢é‡å¤ç»‘å®šå¢åŠ å¼€é”€</strong></p></content><p><a href=https://sund.site/tags/python/>#Python</a></p><div class=toc><nav id=TableOfContents><ul><li><a href=#python-æ‰§è¡Œç¯å¢ƒ>Python æ‰§è¡Œç¯å¢ƒ</a></li><li><a href=#legb-è§„åˆ™>LEGB è§„åˆ™</a></li><li><a href=#python-è™šæ‹Ÿæœºè¿è¡Œæ¡†æ¶>Python è™šæ‹Ÿæœºè¿è¡Œæ¡†æ¶</a></li><li><a href=#python-å­—èŠ‚ç >Python å­—èŠ‚ç </a></li><li><a href=#python-çš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶>Python çš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶</a></li><li><a href=#å‡½æ•°å¯¹è±¡çš„å®ç°>å‡½æ•°å¯¹è±¡çš„å®ç°</a></li><li><a href=#é—­åŒ…çš„å®ç°>é—­åŒ…çš„å®ç°</a></li><li><a href=#å…ƒç±»>å…ƒç±»</a></li><li><a href=#descriptor>Descriptor</a><ul><li><a href=#å¼•ç”³python-é»‘é­”æ³•-descriptor-æè¿°å™¨>å¼•ç”³ï¼šPython é»‘é­”æ³• Descriptor (æè¿°å™¨)</a></li></ul></li><li><a href=#bound-method-å’Œ-unbound-method>Bound Method å’Œ Unbound Method</a></li></ul></nav></div></main><footer>Subscribe via <a href=/index.xml>RSS</a>.<br>Made with
<a href=https://github.com/rokcso/hugo-bearblog-neo/>Hugo Bear Neo</a>.<br>Copyright Â© 2013-2025, Steve Sun.
ğŸ—ºï¸ <a href=/sitemap.xml>Sitemap</a>.</footer></body></html>