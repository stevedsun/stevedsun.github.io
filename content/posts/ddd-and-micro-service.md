---
title: "DDD和微服务中的陷阱"
date: 2019-12-20T21:51:55+08:00
description: ""
---

前几天听到一个客户开发人员讲的笑话：架构师先是给你安利「微服务」，等到你把微服务搞砸了，他再给你安利「DDD」，等DDD也解决不了问题时，他就告诉你：解决以上问题，你还需要搭建一个「中台」……

坦白说，我能够理解笑话背后的苦衷：一方面，DDD、微服务这些概念，很难快速和实际问题建立起联系；另一方面，发明新概念去解决软件架构的旧问题，往往会掩盖其中真正的陷阱。

澄清「DDD和微服务是什么」是一个苦差事。作为开发，我从项目落地的角度，谈谈这些概念**不是**什么。希望能帮你躲过这些坑。

## DDD ≠ 命名游戏

DDD 是老生常谈的话题了，其实很多项目上实施的DDD都是假DDD。

一个很浅显却容易被新手忽视的问题：**代码逻辑在整个架构中所处的地位不是代码所在的文件夹决定的**。假设我们把持久化用户数据的 Repository 叫做 `UserRepository.java`，把它放在`Domain/User`目录下，那这个 Repository 是不是就只能在 User 这个 Domain 下使用了呢？显然不是，代码能不能被调用，跟它放在哪个目录里没有直接的关系。但是落实到项目上，大家往往对这个事实视而不见。很多项目所谓的DDD，仅仅是把不同子域的代码归入不同文件夹，或是纠结到底哪个逻辑放在 Application Service，哪个逻辑放在 Domain Service。

如果你的项目里不需要重构或是改变访问权限就调用其他子域的内部，或是可以跨层级访问本不应该访问的方法，那你可能遇到了假DDD。**好的架构要合理利用编程语言和框架的封装性，把概念约束转化为代码逻辑的约束**。

DDD的一个初衷是让业务人员脑海中的模型和技术人员理解的模型保持一致。所以不得不用业务模型提供的行为来约束代码的开发，比如不允许对数据的直接操作。但做不好架构的团队经常只是用口头来约束。团队内部通过磨合，达成某种不可告人的约定——用日剧对白的口吻来说：

> 大家的心里还是相信DDD的吧……
> 就算是简单的业务逻辑，也请一定要用领域模型提供的方法，不要直接调用资源库……
> 果然大家还是容易犯错啊，所以……请大家记得之前的约定，拜托大家了……

这种约定其实十分脆弱，某天一些成员下项目了，这些口头约定就跟嫁妆一样被带走了。

所以要做DDD的架构落地，先要理解它不是一种约定俗成，而是对代码能做什么、不能做什么的控制。比如宇刚那篇[《端口和适配器架构——DDD好帮手》](https://insights.thoughtworks.cn/port-and-adapter-architecture/)，就是一种思路。

## 微服务架构 ≠ 微服务 * N

当我们决定拆分微服务时，往往对即将发生的意外缺少认识。

Tech Lead 们手起刀落把单体服务拆分到不同微服务里之后，散落在不同服务的功能如何集成变是重要的问题。

集成问题的一个反面教材是数据库集成。不同的服务依赖同一个数据库，那本质上他们还是分在不同进程里跑的同一个业务模块。有人肯定会说：「如果我做了分库分表，两个服务对应到各自的库或表，就没有依赖问题了呀。」

这个想法的初衷是好的，它试图兼顾微服务的扩展性和眼前的资源限制，暂时用同一数据库实例来支持不同的微服务。但要考虑到一个重要的支撑条件——基础设施的稳定性。很多客户为了安全，把数据库单独部署在私有云上，这是个潜在的问题，一旦未来出现服务压力增大，就要同时面对两方面的挑战：一方面来自已有实例的扩展，另一方面客户的基础设施也要经受洗礼。

在这种情况下，单独部署在云上的数据库也要看成一个「服务」，要考虑其性能和部署的压力，你如果做了上面那些「兼顾」，这就是要付出的代价。

另一些团队用SDK集成（客户端集成），就是把自己的接口封装成依赖包，别的服务通过依赖包调用我的服务。这种集成的坑主要有两个：

1. 依赖包不能含有业务逻辑
2. 升级依赖包必须事先经客户端服务确认，这样才能保证客户端服务可独立部署

还有一个特殊情况，依赖源如果是单独部署，比如 Nexus，那么它也是一个「服务」，也存在故障的可能。谁也不希望上线的关键时刻，由于依赖库安装不上导致~~加班~~延期上线吧。

另外，即使躲过上面所有的坑，如果我们的微服务是由同一支团队操刀维护，那么根据康威定律，团队成员很有可能会处理不好服务的边界——出现同一种业务逻辑，一会儿出现在A服务代码里，一会儿出现在B里。一旦部署上线，那这些微服务只能「同呼吸共命运」。

所以可靠的微服务不是简单地把单体服务化整为零，微服务的概念盛行背后有个决定性的前提—— PaaS 的成熟，如果没有好的基础设施团队参与，那微服务的稳定性就全靠听天由命。同时，同一团队在开发多个服务时也要时刻保持对微服务边界的敏感度，减少微服务之间的耦合。

## 小结

本文整理了DDD和微服务在开发团队落地中经常遇到的问题：基于约定的DDD并没有真正落实到架构中；微服务在拆分时也要理解整体大于局部之和，在功能集成时认清各个微服务的依赖关系、边界和客户的云平台现状。