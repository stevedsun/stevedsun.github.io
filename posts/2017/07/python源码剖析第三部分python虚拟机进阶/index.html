<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Steve Sun"><meta name=description content="Python 环境初始化 进程启动后创建PyInterpreterObject，PyInterpreterObject里面维护了全局module映射表interp-&amp;gt;modules，该表默认初始化为__buildin__模块，
Python 的 import 机制  Python虚拟机在执行“import A”时，会为package A创建一个module对象，同时会在该module维护的dict中添加两个表示元信息的属性：name__和__path。而Python虚拟机从A/init.py中执行“import mod1”时，也会为mod1创建一个module对象，同时也会设置__name__属性，但是这时就不设置__path__属性了。
  package是由module聚合而成。更清楚的表述是：module属于一个package。我们不能说，module1属于module2。我们前面已经看到，module的路径实际上是一种树状结构，从图14-11中可以看到，在这个树状结构中，module的父节点只能是package，而不可能是另一个module。
 GIL Python虚拟机使用一个全局解释器锁（Global Interpreter Lock，GIL）来互斥线程对python虚拟机的使用。
注意这里GIL是解释器一级的互斥锁，也就是同一时间只能有一个线程占用python解释器。所以GIL是用来让操作系统中分配的多个线程互斥的使用python解释器的，是建立在系统线程调度基础之上的一套C API互斥机制，是比操作系统线程资源更大粒度的锁。
Python的线程是基于操作系统原生线程的，所以python的线程不是「虚拟出来的」。
 那么究竟Python会在众多的等待线程中选择哪一个幸运儿呢？答案是，不知道。没错，对于这个问题，Python完全没有插手，而是交给了底层的操作系统来解决。也就是说，Python借用了底层操作系统所提供的线程调度机制来决定下一个进入Python解释器的线程究竟是谁。
 GIL在C里对应的结构：
[thread_nt.h] typedef struct NRMUTEX { LONG owned ; DWORD thread_id ; HANDLE hevent ; } NRMUTEX, *PNRMUTEX ; 其中owned初始化为-1，表示锁可用，否则为不可用。thread_id代表线程id，最后一个是平台相关的变量，win32上是一个event内核对象。
多线程 - 标准调度  当Python启动时，是并不支持多线程的。换句话说，Python中支持多线程的数据结构以及GIL都是没有创建的，Python之所以有这种行为是因为大多数的Python程序都不需要多线程的支持
 书中指出，由于python的多线程标准调度机制是有代价的，所以默认单线程不初始化GIL。
 主线程启动后，会用ident = PyThread_start_new_thread(t_bootstrap, (void*) boot);函数调用操作系统内核接口创建子线程，然后主线程挂起等待obj.done。注意，此时主线程中持有GIL。 主线程等待的这段时间里，子线程将自己的线程id等信息设置好，通知内核对象obj.done，唤醒等待中的主线程。此刻，主线程和子线程都同时由操作系统调度，但是主线程一直持有着GIL。 子线程继续执行后进入python解释器，发现需要等待获取GIL。此时子线程主动将自己挂起(而不是由操作系统挂起)。这样就进入了两个线程通过GIL调度的阶段。 主线程被唤醒后，继续执行，直到python内置的时钟计时器_Py_Ticker结束才将自己挂起，让出GIL(_Py_Ticker会在每次执行一条字节码后自动减1，初始默认为100)。  通过上面4步，python的两个线程就完成了从系统调度上升到python标准GIL调度的流程。
阻塞调度 如同上面流程介绍的，标准调度是python使用软件时钟调度线程，那么有时候python的线程会自我阻塞，比如raw_input()、sleep()等函数，这时python就会使用阻塞调度的方式。
 主线程调用sleep(1)后，调用Py_BEGIN_ALLOW_THREADS立刻释放GIL，然后调用操作系统的sleep操作。此时主线程就由操作系统自动管理。 子线程拿到GIL。此时主线程和子线程同时可被操作系统调度。操作系统在执行一段时间子线程后会挂起，调度主线程，发现主线程sleep没结束就挂起主线程，就继续唤醒子线程执行。 当主线程sleep结束，操作系统唤醒主线程。主线程调用Py_END_ALLOW_THREADS再次申请GIL，重新进入python标准调度流程。  可见python在保证线程安全的前提下，允许线程在某些时刻脱离GIL标准调度流程。"><meta name=keywords content=",python"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://sund.site/posts/2017/07/python%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86python%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%9B%E9%98%B6/><title>《Python源码剖析》第三部分——Python虚拟机进阶 :: 电波障害 — Steve Sun's personal website</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://sund.site/main.d7bdd8ee18bfbf4c605488a7e5b1b92cd980dfeed2bdaeab4dd5e931a7a78bc0.css><link rel=apple-touch-icon sizes=180x180 href=https://sund.site/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://sund.site/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://sund.site/favicon-16x16.png><link rel=manifest href=https://sund.site/site.webmanifest><link rel=mask-icon href=https://sund.site/safari-pinned-tab.svg color=#1b1c1d><link rel="shortcut icon" href=https://sund.site/favicon.ico><meta name=msapplication-TileColor content="#1b1c1d"><meta name=theme-color content="#1b1c1d"><meta itemprop=name content="《Python源码剖析》第三部分——Python虚拟机进阶"><meta itemprop=description content="Python 环境初始化 进程启动后创建PyInterpreterObject，PyInterpreterObject里面维护了全局module映射表interp->modules，该表默认初始化为__buildin__模块，
Python 的 import 机制  Python虚拟机在执行“import A”时，会为package A创建一个module对象，同时会在该module维护的dict中添加两个表示元信息的属性：name__和__path。而Python虚拟机从A/init.py中执行“import mod1”时，也会为mod1创建一个module对象，同时也会设置__name__属性，但是这时就不设置__path__属性了。
  package是由module聚合而成。更清楚的表述是：module属于一个package。我们不能说，module1属于module2。我们前面已经看到，module的路径实际上是一种树状结构，从图14-11中可以看到，在这个树状结构中，module的父节点只能是package，而不可能是另一个module。
 GIL Python虚拟机使用一个全局解释器锁（Global Interpreter Lock，GIL）来互斥线程对python虚拟机的使用。
注意这里GIL是解释器一级的互斥锁，也就是同一时间只能有一个线程占用python解释器。所以GIL是用来让操作系统中分配的多个线程互斥的使用python解释器的，是建立在系统线程调度基础之上的一套C API互斥机制，是比操作系统线程资源更大粒度的锁。
Python的线程是基于操作系统原生线程的，所以python的线程不是「虚拟出来的」。
 那么究竟Python会在众多的等待线程中选择哪一个幸运儿呢？答案是，不知道。没错，对于这个问题，Python完全没有插手，而是交给了底层的操作系统来解决。也就是说，Python借用了底层操作系统所提供的线程调度机制来决定下一个进入Python解释器的线程究竟是谁。
 GIL在C里对应的结构：
[thread_nt.h] typedef struct NRMUTEX { LONG owned ; DWORD thread_id ; HANDLE hevent ; } NRMUTEX, *PNRMUTEX ; 其中owned初始化为-1，表示锁可用，否则为不可用。thread_id代表线程id，最后一个是平台相关的变量，win32上是一个event内核对象。
多线程 - 标准调度  当Python启动时，是并不支持多线程的。换句话说，Python中支持多线程的数据结构以及GIL都是没有创建的，Python之所以有这种行为是因为大多数的Python程序都不需要多线程的支持
 书中指出，由于python的多线程标准调度机制是有代价的，所以默认单线程不初始化GIL。
 主线程启动后，会用ident = PyThread_start_new_thread(t_bootstrap, (void*) boot);函数调用操作系统内核接口创建子线程，然后主线程挂起等待obj.done。注意，此时主线程中持有GIL。 主线程等待的这段时间里，子线程将自己的线程id等信息设置好，通知内核对象obj.done，唤醒等待中的主线程。此刻，主线程和子线程都同时由操作系统调度，但是主线程一直持有着GIL。 子线程继续执行后进入python解释器，发现需要等待获取GIL。此时子线程主动将自己挂起(而不是由操作系统挂起)。这样就进入了两个线程通过GIL调度的阶段。 主线程被唤醒后，继续执行，直到python内置的时钟计时器_Py_Ticker结束才将自己挂起，让出GIL(_Py_Ticker会在每次执行一条字节码后自动减1，初始默认为100)。  通过上面4步，python的两个线程就完成了从系统调度上升到python标准GIL调度的流程。
阻塞调度 如同上面流程介绍的，标准调度是python使用软件时钟调度线程，那么有时候python的线程会自我阻塞，比如raw_input()、sleep()等函数，这时python就会使用阻塞调度的方式。
 主线程调用sleep(1)后，调用Py_BEGIN_ALLOW_THREADS立刻释放GIL，然后调用操作系统的sleep操作。此时主线程就由操作系统自动管理。 子线程拿到GIL。此时主线程和子线程同时可被操作系统调度。操作系统在执行一段时间子线程后会挂起，调度主线程，发现主线程sleep没结束就挂起主线程，就继续唤醒子线程执行。 当主线程sleep结束，操作系统唤醒主线程。主线程调用Py_END_ALLOW_THREADS再次申请GIL，重新进入python标准调度流程。  可见python在保证线程安全的前提下，允许线程在某些时刻脱离GIL标准调度流程。"><meta itemprop=datePublished content="2017-07-14T00:00:00+00:00"><meta itemprop=dateModified content="2017-07-14T00:00:00+00:00"><meta itemprop=wordCount content="197"><meta itemprop=image content="https://sund.site"><meta itemprop=keywords content="python,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sund.site"><meta name=twitter:title content="《Python源码剖析》第三部分——Python虚拟机进阶"><meta name=twitter:description content="Python 环境初始化 进程启动后创建PyInterpreterObject，PyInterpreterObject里面维护了全局module映射表interp->modules，该表默认初始化为__buildin__模块，
Python 的 import 机制  Python虚拟机在执行“import A”时，会为package A创建一个module对象，同时会在该module维护的dict中添加两个表示元信息的属性：name__和__path。而Python虚拟机从A/init.py中执行“import mod1”时，也会为mod1创建一个module对象，同时也会设置__name__属性，但是这时就不设置__path__属性了。
  package是由module聚合而成。更清楚的表述是：module属于一个package。我们不能说，module1属于module2。我们前面已经看到，module的路径实际上是一种树状结构，从图14-11中可以看到，在这个树状结构中，module的父节点只能是package，而不可能是另一个module。
 GIL Python虚拟机使用一个全局解释器锁（Global Interpreter Lock，GIL）来互斥线程对python虚拟机的使用。
注意这里GIL是解释器一级的互斥锁，也就是同一时间只能有一个线程占用python解释器。所以GIL是用来让操作系统中分配的多个线程互斥的使用python解释器的，是建立在系统线程调度基础之上的一套C API互斥机制，是比操作系统线程资源更大粒度的锁。
Python的线程是基于操作系统原生线程的，所以python的线程不是「虚拟出来的」。
 那么究竟Python会在众多的等待线程中选择哪一个幸运儿呢？答案是，不知道。没错，对于这个问题，Python完全没有插手，而是交给了底层的操作系统来解决。也就是说，Python借用了底层操作系统所提供的线程调度机制来决定下一个进入Python解释器的线程究竟是谁。
 GIL在C里对应的结构：
[thread_nt.h] typedef struct NRMUTEX { LONG owned ; DWORD thread_id ; HANDLE hevent ; } NRMUTEX, *PNRMUTEX ; 其中owned初始化为-1，表示锁可用，否则为不可用。thread_id代表线程id，最后一个是平台相关的变量，win32上是一个event内核对象。
多线程 - 标准调度  当Python启动时，是并不支持多线程的。换句话说，Python中支持多线程的数据结构以及GIL都是没有创建的，Python之所以有这种行为是因为大多数的Python程序都不需要多线程的支持
 书中指出，由于python的多线程标准调度机制是有代价的，所以默认单线程不初始化GIL。
 主线程启动后，会用ident = PyThread_start_new_thread(t_bootstrap, (void*) boot);函数调用操作系统内核接口创建子线程，然后主线程挂起等待obj.done。注意，此时主线程中持有GIL。 主线程等待的这段时间里，子线程将自己的线程id等信息设置好，通知内核对象obj.done，唤醒等待中的主线程。此刻，主线程和子线程都同时由操作系统调度，但是主线程一直持有着GIL。 子线程继续执行后进入python解释器，发现需要等待获取GIL。此时子线程主动将自己挂起(而不是由操作系统挂起)。这样就进入了两个线程通过GIL调度的阶段。 主线程被唤醒后，继续执行，直到python内置的时钟计时器_Py_Ticker结束才将自己挂起，让出GIL(_Py_Ticker会在每次执行一条字节码后自动减1，初始默认为100)。  通过上面4步，python的两个线程就完成了从系统调度上升到python标准GIL调度的流程。
阻塞调度 如同上面流程介绍的，标准调度是python使用软件时钟调度线程，那么有时候python的线程会自我阻塞，比如raw_input()、sleep()等函数，这时python就会使用阻塞调度的方式。
 主线程调用sleep(1)后，调用Py_BEGIN_ALLOW_THREADS立刻释放GIL，然后调用操作系统的sleep操作。此时主线程就由操作系统自动管理。 子线程拿到GIL。此时主线程和子线程同时可被操作系统调度。操作系统在执行一段时间子线程后会挂起，调度主线程，发现主线程sleep没结束就挂起主线程，就继续唤醒子线程执行。 当主线程sleep结束，操作系统唤醒主线程。主线程调用Py_END_ALLOW_THREADS再次申请GIL，重新进入python标准调度流程。  可见python在保证线程安全的前提下，允许线程在某些时刻脱离GIL标准调度流程。"><meta property="og:title" content="《Python源码剖析》第三部分——Python虚拟机进阶"><meta property="og:description" content="Python 环境初始化 进程启动后创建PyInterpreterObject，PyInterpreterObject里面维护了全局module映射表interp->modules，该表默认初始化为__buildin__模块，
Python 的 import 机制  Python虚拟机在执行“import A”时，会为package A创建一个module对象，同时会在该module维护的dict中添加两个表示元信息的属性：name__和__path。而Python虚拟机从A/init.py中执行“import mod1”时，也会为mod1创建一个module对象，同时也会设置__name__属性，但是这时就不设置__path__属性了。
  package是由module聚合而成。更清楚的表述是：module属于一个package。我们不能说，module1属于module2。我们前面已经看到，module的路径实际上是一种树状结构，从图14-11中可以看到，在这个树状结构中，module的父节点只能是package，而不可能是另一个module。
 GIL Python虚拟机使用一个全局解释器锁（Global Interpreter Lock，GIL）来互斥线程对python虚拟机的使用。
注意这里GIL是解释器一级的互斥锁，也就是同一时间只能有一个线程占用python解释器。所以GIL是用来让操作系统中分配的多个线程互斥的使用python解释器的，是建立在系统线程调度基础之上的一套C API互斥机制，是比操作系统线程资源更大粒度的锁。
Python的线程是基于操作系统原生线程的，所以python的线程不是「虚拟出来的」。
 那么究竟Python会在众多的等待线程中选择哪一个幸运儿呢？答案是，不知道。没错，对于这个问题，Python完全没有插手，而是交给了底层的操作系统来解决。也就是说，Python借用了底层操作系统所提供的线程调度机制来决定下一个进入Python解释器的线程究竟是谁。
 GIL在C里对应的结构：
[thread_nt.h] typedef struct NRMUTEX { LONG owned ; DWORD thread_id ; HANDLE hevent ; } NRMUTEX, *PNRMUTEX ; 其中owned初始化为-1，表示锁可用，否则为不可用。thread_id代表线程id，最后一个是平台相关的变量，win32上是一个event内核对象。
多线程 - 标准调度  当Python启动时，是并不支持多线程的。换句话说，Python中支持多线程的数据结构以及GIL都是没有创建的，Python之所以有这种行为是因为大多数的Python程序都不需要多线程的支持
 书中指出，由于python的多线程标准调度机制是有代价的，所以默认单线程不初始化GIL。
 主线程启动后，会用ident = PyThread_start_new_thread(t_bootstrap, (void*) boot);函数调用操作系统内核接口创建子线程，然后主线程挂起等待obj.done。注意，此时主线程中持有GIL。 主线程等待的这段时间里，子线程将自己的线程id等信息设置好，通知内核对象obj.done，唤醒等待中的主线程。此刻，主线程和子线程都同时由操作系统调度，但是主线程一直持有着GIL。 子线程继续执行后进入python解释器，发现需要等待获取GIL。此时子线程主动将自己挂起(而不是由操作系统挂起)。这样就进入了两个线程通过GIL调度的阶段。 主线程被唤醒后，继续执行，直到python内置的时钟计时器_Py_Ticker结束才将自己挂起，让出GIL(_Py_Ticker会在每次执行一条字节码后自动减1，初始默认为100)。  通过上面4步，python的两个线程就完成了从系统调度上升到python标准GIL调度的流程。
阻塞调度 如同上面流程介绍的，标准调度是python使用软件时钟调度线程，那么有时候python的线程会自我阻塞，比如raw_input()、sleep()等函数，这时python就会使用阻塞调度的方式。
 主线程调用sleep(1)后，调用Py_BEGIN_ALLOW_THREADS立刻释放GIL，然后调用操作系统的sleep操作。此时主线程就由操作系统自动管理。 子线程拿到GIL。此时主线程和子线程同时可被操作系统调度。操作系统在执行一段时间子线程后会挂起，调度主线程，发现主线程sleep没结束就挂起主线程，就继续唤醒子线程执行。 当主线程sleep结束，操作系统唤醒主线程。主线程调用Py_END_ALLOW_THREADS再次申请GIL，重新进入python标准调度流程。  可见python在保证线程安全的前提下，允许线程在某些时刻脱离GIL标准调度流程。"><meta property="og:type" content="article"><meta property="og:url" content="https://sund.site/posts/2017/07/python%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86python%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%9B%E9%98%B6/"><meta property="og:image" content="https://sund.site"><meta property="article:published_time" content="2017-07-14T00:00:00+00:00"><meta property="article:modified_time" content="2017-07-14T00:00:00+00:00"><meta property="article:published_time" content="2017-07-14 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=https://sund.site/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>cd /home/steve</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://sund.site/about/>About</a></li><li><a href=https://sund.site/posts/>Posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>One minute</p></div><article><h1 class=post-title><a href=https://sund.site/posts/2017/07/python%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86python%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%9B%E9%98%B6/>《Python源码剖析》第三部分——Python虚拟机进阶</a></h1><div class=post-content><h2 id=python-环境初始化>Python 环境初始化</h2><p>进程启动后创建PyInterpreterObject，PyInterpreterObject里面维护了全局module映射表<code>interp->modules</code>，该表默认初始化为__buildin__模块，</p><h2 id=python-的-import-机制>Python 的 import 机制</h2><blockquote><p>Python虚拟机在执行“import A”时，会为package A创建一个module对象，同时会在该module维护的dict中添加两个表示元信息的属性：<strong>name__和__path</strong>。而Python虚拟机从A/<strong>init</strong>.py中执行“import mod1”时，也会为mod1创建一个module对象，同时也会设置__name__属性，但是这时就不设置__path__属性了。</p></blockquote><blockquote><p>package是由module聚合而成。更清楚的表述是：module属于一个package。我们不能说，module1属于module2。我们前面已经看到，module的路径实际上是一种树状结构，从图14-11中可以看到，在这个树状结构中，module的父节点只能是package，而不可能是另一个module。</p></blockquote><h2 id=gil>GIL</h2><p>Python虚拟机使用一个全局解释器锁（Global Interpreter Lock，GIL）来互斥线程对python虚拟机的使用。</p><p>注意这里GIL是解释器一级的互斥锁，也就是同一时间只能有一个线程占用python解释器。所以<strong>GIL是用来让操作系统中分配的多个线程互斥的使用python解释器的，是建立在系统线程调度基础之上的一套C API互斥机制</strong>，是比操作系统线程资源更大粒度的锁。</p><p>Python的线程是基于操作系统原生线程的，所以python的线程不是「虚拟出来的」。</p><blockquote><p>那么究竟Python会在众多的等待线程中选择哪一个幸运儿呢？答案是，不知道。没错，对于这个问题，Python完全没有插手，而是交给了底层的操作系统来解决。也就是说，Python借用了底层操作系统所提供的线程调度机制来决定下一个进入Python解释器的线程究竟是谁。</p></blockquote><p>GIL在C里对应的结构：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>[thread_nt.h]
<span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> NRMUTEX {
    LONG   owned ;
    DWORD  thread_id ;
    HANDLE hevent ;
} NRMUTEX, <span style=color:#f92672>*</span>PNRMUTEX ;
</code></pre></div><p>其中<code>owned</code>初始化为-1，表示锁可用，否则为不可用。<code>thread_id</code>代表线程id，最后一个是平台相关的变量，win32上是一个event内核对象。</p><h2 id=多线程---标准调度>多线程 - 标准调度</h2><blockquote><p>当Python启动时，是并不支持多线程的。换句话说，Python中支持多线程的数据结构以及GIL都是没有创建的，Python之所以有这种行为是因为大多数的Python程序都不需要多线程的支持</p></blockquote><p>书中指出，由于python的多线程标准调度机制是有代价的，所以默认单线程不初始化GIL。</p><ol><li>主线程启动后，会用<code>ident = PyThread_start_new_thread(t_bootstrap, (void*) boot);</code>函数调用操作系统内核接口创建子线程，然后主线程挂起等待<code>obj.done</code>。注意，此时主线程中持有GIL。</li><li>主线程等待的这段时间里，子线程将自己的线程id等信息设置好，通知内核对象<code>obj.done</code>，唤醒等待中的主线程。此刻，主线程和子线程都同时由操作系统调度，但是主线程一直持有着GIL。</li><li>子线程继续执行后进入python解释器，发现需要等待获取GIL。此时子线程主动将自己挂起(而不是由操作系统挂起)。这样就进入了两个线程通过GIL调度的阶段。</li><li>主线程被唤醒后，继续执行，直到python内置的时钟计时器<code>_Py_Ticker</code>结束才将自己挂起，让出GIL(<code>_Py_Ticker</code>会在每次执行一条字节码后自动减1，初始默认为100)。</li></ol><p>通过上面4步，python的两个线程就完成了从系统调度上升到python标准GIL调度的流程。</p><h2 id=阻塞调度>阻塞调度</h2><p>如同上面流程介绍的，标准调度是python使用软件时钟调度线程，那么有时候python的线程会自我阻塞，比如<code>raw_input()</code>、<code>sleep()</code>等函数，这时python就会使用阻塞调度的方式。</p><ol><li>主线程调用<code>sleep(1)</code>后，调用<code>Py_BEGIN_ALLOW_THREADS</code>立刻释放GIL，然后调用操作系统的sleep操作。此时主线程就由操作系统自动管理。</li><li>子线程拿到GIL。此时主线程和子线程同时可被操作系统调度。操作系统在执行一段时间子线程后会挂起，调度主线程，发现主线程sleep没结束就挂起主线程，就继续唤醒子线程执行。</li><li>当主线程sleep结束，操作系统唤醒主线程。主线程调用<code>Py_END_ALLOW_THREADS</code>再次申请GIL，重新进入python标准调度流程。</li></ol><p><strong>可见python在保证线程安全的前提下，允许线程在某些时刻脱离GIL标准调度流程。</strong></p><p>其中<code>Py_BEGIN_ALLOW_THREADS</code>和<code>Py_END_ALLOW_THREADS</code>两个负责释放和等待GIL的宏的实现如下。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>[ceval.h]
<span style=color:#75715e>#define Py_BEGIN_ALLOW_THREADS { \
</span><span style=color:#75715e>            PyThreadState *_save; \
</span><span style=color:#75715e>            _save = PyEval_SaveThread();
</span><span style=color:#75715e>#define Py_END_ALLOW_THREADS    PyEval_RestoreThread(_save); \
</span><span style=color:#75715e>         }
</span><span style=color:#75715e></span>
[ceval.c]
PyThreadState<span style=color:#f92672>*</span> PyEval_SaveThread(<span style=color:#66d9ef>void</span>)
{
    PyThreadState <span style=color:#f92672>*</span>tstate <span style=color:#f92672>=</span> PyThreadState_Swap(NULL);
    <span style=color:#66d9ef>if</span> (interpreter_lock)
        PyThread_release_lock(interpreter_lock);
    <span style=color:#66d9ef>return</span> tstate;
}

<span style=color:#66d9ef>void</span> PyEval_RestoreThread(PyThreadState <span style=color:#f92672>*</span>tstate)
{
    <span style=color:#66d9ef>if</span> (interpreter_lock) {
        <span style=color:#66d9ef>int</span> err <span style=color:#f92672>=</span> errno;
        PyThread_acquire_lock(interpreter_lock, <span style=color:#ae81ff>1</span>);
        errno <span style=color:#f92672>=</span> err;
    }
    PyThreadState_Swap(tstate);
}
</code></pre></div><h2 id=用户级互斥>用户级互斥</h2><p>用户级的互斥锁利用操作系统的互斥机制实现，同时要考虑防止和GIL形成死锁。所以过程与阻塞调度类似需要使用<code>Py_BEGIN_ALLOW_THREADS</code>和<code>Py_END_ALLOW_THREADS</code>这两个宏。</p><ol><li>线程a调用lock对象加锁，lock对象内部调用系统互斥机制，同时执行<code>Py_BEGIN_ALLOW_THREADS</code>释放GIL防止死锁。</li><li>线程b获得GIL，执行到某处释放锁，lock对象内部调用系统机制释放锁，同时底层调用了<code>Py_END_ALLOW_THREADS</code>等待GIL。</li><li>线程a被系统唤醒，获取GIL，一气呵成。</li></ol><h2 id=子线程的销毁>子线程的销毁</h2><blockquote><p>在线程的全部计算完成之后，Python将销毁线程。需要注意的是，Python主线程的销毁与子线程的销毁是不同的，因为主线程的销毁动作必须要销毁Python的运行时环境，而子线程的销毁则不需要进行这些动作。</p></blockquote><h2 id=内存管理>内存管理</h2><p>大块内存管理直接调用C的malloc和free接口，小块内存分配则由python的内存池管理机制调度。</p><h3 id=小块内存管理的对象>小块内存管理的对象</h3><p>Python的内存块叫block，每个block大小不同，都是8的整数倍。管理block的叫pool，一个pool是4K。pool管理<strong>相同大小</strong>的一堆block。pool对象的szindex变量保存了这个pool对应的block大小。</p><blockquote><p>，一个pool可能管理了100个32个字节的block，也可能管理了100个64个字节的block，但是绝不会有一个管理了50个32字节的block和50个64字节的block的pool存在</p></blockquote><p>Python对于内存块的管理类似对象的策略，每次内存分配一整个block，回收时先将不用的Block加入闲置的队列里等待重新利用，不是直接回收。(惰性回收策略)</p><p>管理多个pool的数据对象是arena。下图可见，pool结构是一次性分配好一块内存，而arena则是通过指针连向一块pool。</p><p><img src=https://i.loli.net/2021/03/05/2duvofnkP9LEO8x.jpg alt></p><p>而python维护一个名叫arenas的数组，数组元素就是arena对象。arena之间通过由两条链表相连。它们分别是：</p><ul><li><em>unused_arena_objects</em> 是单向量表，指向未分配pool的arena</li><li><em>usable_arenas</em> 是双向链表，表示已经分配了pool的arena</li></ul><p><img src=https://i.loli.net/2021/03/05/duFq5I6lWACjQyw.jpg alt></p><blockquote><p>当一个arena的area_object没有与pool集合建立联系时，这时的arena处于“未使用”状态；一旦建立了联系，这时arena就转换到了“可用”状态。对于每一种状态，都有一个arena的链表。“未使用”的arena的链表表头是unused_arena_objects、arena与arena之间通过nextarena连接，是一个单向链表；而“可用”的arena的链表表头是usable_arenas、arena与arena之间通过nextarena和prevarena连接，是一个双向链表。</p></blockquote><p><strong>Pool是python管理内存的对象，arena虽然更上层，但是arena内的pool集合可能管理32字节的block，也可能管理64字节的block，所以arena无法决定销毁和分配内存。Python仍然以pool为单位管理内存开销。(pool有size概念，arena没有size概念)</strong></p><p>Pool有三种状态full、empty和used。其中full不需要连接起来，其他两种状态会被freepools和usedpools连接起来方便管理。</p><p><img src=https://i.loli.net/2021/03/05/mZr1P7ocQYbpCFB.jpg alt></p><h3 id=arena的分配>arena的分配</h3><p>arena可以指向32位pool集合，也可以指向64位pool集合。分配内存的过程如下：</p><ol><li>先在usable_arenas链表上找可用的arena，然后找到符合要求的pool</li><li>如果没有可用的arena，则从arenas数组里摘下来新的arena，放在usable_arenas里，然后初始化pool</li><li>从usedpools链表里找可用的blocks</li><li>usedpools没有可用的pool，就从freepools链表分配一个empty状态的pool</li></ol><h3 id=python编译时指定内存上限>Python编译时指定内存上限</h3><blockquote><p>当Python在WITH_MEMORY_LIMITS编译符号打开的背景下进行编译时，Python内部的另一个符号会被激活，这个名为SMALL_MEMORY_LIMIT的符号限制了整个内存池的大小，同时，也就限制了可以创建的arena的个数。在默认情况下，不论是Win32平台，还是unix平台，这个编译符号都是没有打开的，所以通常Python都没有对小块内存的内存池的大小做任何的限制。</p></blockquote><h3 id=小块内存管理的流程>小块内存管理的流程</h3><p><em>(此部分摘自书中代码注释)</em></p><ol><li>如果申请的内存小于SMALL_REQUEST_THRESHOLD，使用Python的小块内存的内存池。否则，转向malloc</li><li>根据申请内存的大小获得对应的size class index</li><li>如果usedpools中可用的pool，使用这个pool来分配block</li><li>分配结束后，如果pool中的block都被分配了，将pool从usedpools中摘除</li><li>如果usedpools中没有可用的pool，从usable_arenas中获取pool</li><li>如果usable_arenas中没有就“可用”的arena，开始申请arena</li><li>从usable_arenas的第一个arena中获取一个pool</li><li>获取pool成功，进行init pool的动作，将pool放入used_pools中，并返回分配得到的block</li><li>获取pool失败，对arena中的pool集合进行初始化，然后转入goto到init pool的动作处，初始化一个特定的pool</li></ol><h3 id=python-25对多次分配小内存造成内存泄漏的处理>Python 2.5对多次分配小内存造成内存泄漏的处理</h3><p>在2.5之前版本，Python的arena从来不释放pool。这就造成反复分配小内存后造成的arena太多而内存无法回收。</p><p>2.5之后的处理办法：arena有两种状态，unused和usable。上文已经介绍过。</p><ol><li>如果arena中所有的pool都是empty的，释放pool集合占用的内存。arena变成unused状态，从usable_arenas剔除</li><li>如果arena初始化了新的pool，arena变成usable状态，从usable_arenas链表中顺序查找位置插入该arena。注意，usable_arenas是有序链表(按照arena中pool的个数排序，pool多的arena排前边，pool少的排后边)</li><li>这样，再有分配内存的请求时，先从usable_arenas表头顺序查，排在前边pool多的arena就被利用的充分，pool少的arena就更有可能变成unused状态，容易被释放掉。达到节省内存的目的</li></ol><h3 id=内存池全景>内存池全景</h3><p><img src=https://i.loli.net/2021/03/05/1Lh6u4awv8ZyQ9H.jpg alt></p><h2 id=python垃圾回收机制>Python垃圾回收机制</h2><p>除了计数器，python还是使用了标记-清除，分代回收机制。</p><h3 id=标记---清除>标记 - 清除</h3><h4 id=三色模型>三色模型</h4><p>根据系统内所有对象的引用情况建立有向图，沿着有向图从根开始的逐层染色，黑色代表该节点所有引用都检查过了，灰色表示节点是可达的，当所有灰色节点都变为黑色，检查结束。</p><p><img src=https://i.loli.net/2021/03/05/2a1kYDnyT4fBQxP.jpg alt></p><h3 id=python-中的标记清除>Python 中的标记清除</h3><p>Python的对象由三大部分组成，PyGC_Head，PyObject_Head和本体。其中PyObject_Head里存计数器用来标记当前节点是否可回收，但是对于循环引用的情况，就需要PyGC_Head里的refs，python会根据一些触发条件进行三色模型的标记，某个对象的「可达次数」标记在PyGC_Head里，当这个可达次数为0时，代表对象不可达，也就需要回收之。PyGC_Head之间有一条双向链表连接了所有对象，将他们纳入内存回收管理系统里。</p><p><img src=https://i.loli.net/2021/03/05/UT5ry697VXINBQp.jpg alt></p><h4 id=流程>流程</h4><ol><li>在垃圾收集的第一步，就是遍历可收集对象链表，将每个对象的gc.gc_ref值设置为其ob_refcnt值。</li><li>接下来的动作就是要将环引用从引用中摘除。</li><li>有一些container对象的<code>PyGC_Head.gc.gc_ref</code>还不为0，这就意味着存在对这些对象的外部引用，这些对象，就是开始标记 - 清除算法的root object集合。</li></ol><h3 id=分代回收>分代回收</h3><blockquote><p>这种以空间换时间的总体思想是：将系统中的所有内存块根据其存活时间划分为不同的集合，每一个集合就称为一个“代”，垃圾收集的频率随着“代”的存活时间的增大而减小，也就是说，活得越长的对象，就越可能不是垃圾，就应该越少去收集。</p></blockquote><p><img src=https://i.loli.net/2021/03/05/mQuPrwyD73ZjhBv.jpg alt></p><blockquote><p>Python采用了三代的分代收集机制，如果当前收集的是第1代，那么在开始垃圾收集之前，Python会将比其“年轻”的所有代的内存链表（当然，在这里只有第0代）整个地链接到第1代内存链表之后，这个操作是通过gc_list_merge实现的。</p></blockquote><h3 id=总结>总结</h3><ol><li>将比当前处理的“代”更年轻的“代”的链表合并到当前“代”中</li><li>在待处理链表上进行打破循环的模拟，寻找root object</li><li>将待处理链表中的unreachable object转移到unreachable链表中，处理完成后，当前“代”中只剩下reachable object了</li><li>如果可能，将当前“代”中的reachable object合并到更老的“代”中</li><li>对于unreachable链表中的对象，如果其带有<code>__del__</code>函数，则不能安全回收，需要将这些对象收集到finalizers链表中，因此，这些对象引用的对象也不能回收,也需要放入finalizers链表中</li><li>处理弱引用（weakref），如果可能，调用弱引用中注册的callback操作</li><li>对unreachable链表上的对象进行垃圾回收操作</li><li>将含有<code>__del__</code>操作的实例对象收集到Python内部维护的名为garbage的链表中，同时将finalizers链表中所有对象加入old链表中</li></ol><p><strong>注意，如果对象拥有<code>__del__</code>方法，就不能通过垃圾回收来自动回收</strong>，所以要慎重使用这个方法。</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://sund.site/tags/python/>python</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>197 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2017-07-14 00:00</p></div><hr><div class=sharing-buttons><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f" target=_blank rel=noopener aria-label title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f" target=_blank rel=noopener aria-label title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.tumblr.com/widgets/share/tool?posttype=link&title=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6&caption=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6&canonicalUrl=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f" target=_blank rel=noopener aria-label title="Share on tumblr"><div class="resp-sharing-button resp-sharing-button--tumblr resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.563 24c-5.093.0-7.031-3.756-7.031-6.411V9.747H5.116V6.648c3.63-1.313 4.512-4.596 4.71-6.469C9.84.051 9.941.0 9.999.0h3.517v6.114h4.801v3.633h-4.82v7.47c.016 1.001.375 2.371 2.207 2.371h.09c.631-.02 1.486-.205 1.936-.419l1.156 3.425c-.436.636-2.4 1.374-4.156 1.404h-.178l.011.002z"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6&body=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f" target=_self rel=noopener aria-label title="Share via email"><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div></div></a><a class=resp-sharing-button__link href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f&media=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f;description=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6" target=_blank rel=noopener aria-label title="Share on pinterest"><div class="resp-sharing-button resp-sharing-button--pinterest resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12.017.0C5.396.0.029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024.0 1.518.769 1.518 1.688.0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128.0 3.768-2.245 3.768-5.487.0-2.861-2.063-4.869-5.008-4.869-3.41.0-5.409 2.562-5.409 5.199.0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646.0-3.776 2.748-7.252 7.92-7.252 4.158.0 7.392 2.967 7.392 6.923.0 4.135-2.607 7.462-6.233 7.462-1.214.0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607.0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017.0z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f&title=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6&summary=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6&source=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f" target=_blank rel=noopener aria-label title="Share on linkedin"><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f&resubmit=true&title=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6" target=_blank rel=noopener aria-label title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249s-.561-1.249-1.249-1.249zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248s1.249-.561 1.249-1.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.xing.com/app/user?op=share;url=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f;title=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6" target=_blank rel=noopener aria-label title="Share on xing"><div class="resp-sharing-button resp-sharing-button--xing resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></svg></div></div></a><a class=resp-sharing-button__link href="whatsapp://send?text=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6%20https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f" target=_blank rel=noopener aria-label title="Share on whatsapp"><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893a11.821 11.821.0 00-3.48-8.413z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f&t=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6" target=_blank rel=noopener aria-label title="Share on hacker news"><div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://telegram.me/share/url?text=%e3%80%8aPython%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90%e3%80%8b%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e2%80%94%e2%80%94Python%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%9b%e9%98%b6&url=https%3a%2f%2fsund.site%2fposts%2f2017%2f07%2fpython%25E6%25BA%2590%25E7%25A0%2581%25E5%2589%2596%25E6%259E%2590%25E7%25AC%25AC%25E4%25B8%2589%25E9%2583%25A8%25E5%2588%2586python%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E8%25BF%259B%25E9%2598%25B6%2f" target=_blank rel=noopener aria-label title="Share on telegram"><div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div></div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://sund.site/posts/2018/10/%E8%B7%A8%E8%BF%87%E7%9C%9F%E5%AE%9E%E5%92%8C%E8%99%9A%E6%97%A0%E7%9A%84%E6%B2%B3/><span class=button__icon>←</span>
<span class=button__text>跨过真实和虚无的河</span></a></span>
<span class="button next"><a href=https://sund.site/posts/2017/07/python%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86python%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%9F%BA%E7%A1%80/><span class=button__text>《Python源码剖析》第二部分——Python虚拟机基础</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://sund.site>Steve Sun</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span><span><a href=https://sund.site/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span><a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=https://sund.site/bundle.min.af435e44374f1e99a669ea8cd5bb9a2fceed80588941a451bfddb66b86a67c9f40b0f417e9543a763f809aa7e9300d7b1d69bf99615810ba02ac70396d50fad5.js integrity="sha512-r0NeRDdPHpmmaeqM1buaL87tgFiJQaRRv922a4amfJ9AsPQX6VQ6dj+AmqfpMA17HWm/mWFYELoCrHA5bVD61Q=="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-64688885-1','auto');ga('send','pageview');}</script></body></html>