<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=en dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Building a File Parser - The Context Works</title>
<meta name=theme-color><meta name=description content="Last week, after reading this article - How to Write a Lexer in Go, I found that it is not so difficult to design a configuration file parser by this article&rsquo;s mindset. Then I tried to write a fluent-bit configuration parser and finally got this Fluent-Bit configuration parser for Golang.
In this article, I want to introduce how to parse Fluent-bit configuration .conf file, and the thinking behind it.
Fluent-bit configuration format and schema
[FIRST_SECTION]
    Key1  some value
    Key2  another value

[SECOND_SECTION]
    KeyN  3.14
Here is a classic mode configuration of Fluent-bit, it includes two parts:"><meta name=author content="Steve Sun"><link rel="preload stylesheet" as=style href=https://sund.site/main.min.css><link rel=preload as=image href=https://sund.site/theme.svg><link rel=preload as=image href=https://sund.site/images/profile.png><link rel=preload as=image href=https://sund.site/github.svg><link rel=preload as=image href=https://sund.site/rss.svg><script defer src=https://sund.site/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://sund.site/favicon.ico><link rel=apple-touch-icon href=https://sund.site/apple-touch-icon.png><meta name=generator content="Hugo 0.136.4"><script async src="https://www.googletagmanager.com/gtag/js?id=G-XJJVVQ0LBH"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XJJVVQ0LBH")}</script><meta itemprop=name content="Building a File Parser"><meta itemprop=description content="Thinking in lexer for any format configuration file."><meta itemprop=datePublished content="2022-05-08T14:00:00+08:00"><meta itemprop=dateModified content="2022-05-08T14:00:00+08:00"><meta itemprop=wordCount content="614"><meta itemprop=keywords content="Go,Fluentbit"><meta property="og:url" content="https://sund.site/posts/2022/2022-5-8_lexer_design/"><meta property="og:site_name" content="The Context Works"><meta property="og:title" content="Building a File Parser"><meta property="og:description" content="Thinking in lexer for any format configuration file."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-08T14:00:00+08:00"><meta property="article:modified_time" content="2022-05-08T14:00:00+08:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="Fluentbit"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building a File Parser"><meta name=twitter:description content="Thinking in lexer for any format configuration file."><link rel=canonical href=https://sund.site/posts/2022/2022-5-8_lexer_design/><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2639081419131654" crossorigin=anonymous></script></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center"><div class="relative z-50 ltr:mr-auto rtl:ml-auto flex items-center"><a class="-translate-y-[1px] text-2xl font-medium" href=https://sund.site/>The Context Works</a><div class="btn-dark text-[0] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 ltr:-mr-8 rtl:-ml-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a>
<a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/blogroll/>Blogroll</a></nav><nav class="mt-12 flex justify-center space-x-10 rtl:space-x-reverse dark:invert ltr:lg:ml-14 rtl:lg:mr-14 lg:mt-0 lg:items-center"><a class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/stevedsun target=_blank rel=me>github
</a><a class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://sund.site/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"><article><header class=mb-14><h1 class="!my-0 pb-2.5">Building a File Parser</h1><div class="text-xs antialiased opacity-60"><time>May 8, 2022</time></div></header><section><p>Last week, after reading this article - <a href=https://www.aaronraff.dev/blog/how-to-write-a-lexer-in-go>How to Write a Lexer in Go</a>, I found that it is not so difficult to design a configuration file parser by this article&rsquo;s mindset. Then I tried to write a fluent-bit configuration parser and finally got this <a href=https://github.com/stevedsun/go-fluentbit-conf-parser>Fluent-Bit configuration parser for Golang</a>.</p><p>In this article, I want to introduce how to parse Fluent-bit configuration <code>.conf</code> file, and the thinking behind it.</p><h2 id=fluent-bit-configuration-format-and-schema>Fluent-bit configuration format and schema</h2><pre tabindex=0><code>[FIRST_SECTION]
    Key1  some value
    Key2  another value

[SECOND_SECTION]
    KeyN  3.14
</code></pre><p>Here is a classic mode configuration of Fluent-bit, it includes two parts:</p><ul><li>Section</li><li>Key/value pair</li></ul><p>First of all, we need to define a struct that represents the Fluent-bit configuration file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FluentBitConf</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Sections</span> []<span style=color:#a6e22e>Section</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Section</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Entries</span> []<span style=color:#a6e22e>Entry</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Entry</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Key</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Value</span> <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Once we have a struct, the next step is to parse tokens from the file and save their values into golang struct. We can copy the logic of the lexer to develop our fluent bit parser.</p><p>In a lexer program, the target characters which we want to parse out are called &ldquo;Token&rdquo;, Token is also the keyword that our parser program is searching for. A parser program will read characters in a file one by one, whenever it found a token, the parser saves the value between tokens into the final structure and go ahead.</p><h2 id=parse-a-single-token>Parse a single token</h2><p>If we want to parse a Section, we have to make the parser read characters one by one and stop at <code>[</code> character, which means the beginning of a Section. The parser must save the current state as <code>t_section</code> and keep the parser reading until <code>]</code> character, the word between <code>[</code> and <code>]</code> is the Section value we need to persist into go struct.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// define some tag to tell parser state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t_section</span> = <span style=color:#66d9ef>iota</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>parser</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FluentBitConfParser</span>) <span style=color:#a6e22e>Parse</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>FluentBitConf</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>currSection</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Section</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// read charector one by one
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>reader</span>.<span style=color:#a6e22e>ReadRune</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// stop at the end of file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>EOF</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>currSection</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>Conf</span>.<span style=color:#a6e22e>Sections</span> = append(<span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>Conf</span>.<span style=color:#a6e22e>Sections</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>currSection</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>Conf</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>Conf</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>r</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;\n&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;[&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#75715e>// save last config item
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>currSection</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>Conf</span>.<span style=color:#a6e22e>Sections</span> = append(<span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>Conf</span>.<span style=color:#a6e22e>Sections</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>currSection</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// create new config item
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>currSection</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Section</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Name</span>:    <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Entries</span>: []<span style=color:#a6e22e>Entry</span>{},
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>token</span> = <span style=color:#a6e22e>t_section</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>IsSpace</span>(<span style=color:#a6e22e>r</span>) {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// here is important function, read the charectors after token-chareactor and save them into struct
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>strValue</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>parseString</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>token</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>t_section</span>:
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>currSection</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#a6e22e>strValue</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>token</span> = <span style=color:#a6e22e>t_entry_key</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In function <code>parser.parseString()</code>, we have to read until the end of a value (for section, it&rsquo;s <code>]</code>), then return the value.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>parser</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FluentBitConfParser</span>) <span style=color:#a6e22e>parseString</span>() (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>reader</span>.<span style=color:#a6e22e>UnreadRune</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>reader</span>.<span style=color:#a6e22e>ReadRune</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>EOF</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>val</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>token</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>t_section</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>r</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;]&#39;</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>val</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>val</span> = <span style=color:#a6e22e>val</span> <span style=color:#f92672>+</span> string(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That&rsquo;s all logic for parsing a section. Parse key/value pair is the same process, just note to make the parser know which state it is and save values between whitespace or <code>\n</code>, you can see the code in <a href=https://github.com/stevedsun/go-fluentbit-conf-parser/blob/master/parser.go>the Github repo</a>.</p><h2 id=conclusion>Conclusion</h2><p>To parse a configuration file, we have to</p><ul><li>Defining token (key characters)</li><li>Reading characters and looking for a token</li><li>Saving current state to tell parser which struct the following characters belong</li></ul></section><footer class="mt-12 flex flex-wrap"><a class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]" href=https://sund.site/tags/go>go</a>
<a class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]" href=https://sund.site/tags/fluentbit>fluentbit</a></footer><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg !leading-[1.2] *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://sund.site/posts/2022/using_notion_as_a_dashboard/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>Notion as a Dashboard</span></a>
<a class="ltr:ml-auto rtl:mr-auto justify-end pl-3" href=https://sund.site/posts/2021/distributed-cache/><span>分布式缓存系统的设计</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav><div class=mt-24 id=graphcomment></div><script type=text/javascript>var __semio__params={graphcommentId:"steve-sun",behaviour:{}};function __semio__onload(){__semio__gc_graphlogin(__semio__params)}(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.onload=__semio__onload,e.defer=!0,e.src="https://integration.graphcomment.com/gc_graphlogin.js?"+Date.now(),(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script></article></main><footer class="mx-auto flex h-[4.5rem] max-w-[--w] items-center px-8 text-xs uppercase tracking-wider opacity-60"><div class=mr-auto>Copyright © 2024, Steve Sun; all rights reserved.</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>hugo-paper</a></footer></body></html>