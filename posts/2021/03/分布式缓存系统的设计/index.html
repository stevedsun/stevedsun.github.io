<!doctype html><html lang=en-us><head><title>分布式缓存系统的设计 | 电波障害</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="写作者分享思想，同时也帮助自己思考。"><meta name=generator content="Hugo 0.79.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-64688885-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class=navigation><a href=/><span class=arrow>←</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a>
<a class=button href=https://sund.site/index.xml>Subscribe</a></nav><main class=main><section id=single><h1 class=title>分布式缓存系统的设计</h1><div class=tip><span>Mar 18, 2021 15:32</span>
<span class=split>·</span>
<span>2239 words</span>
<span class=split>·</span>
<span>5 minute read</span></div><div class=content><p>很久不写技术文章了。这是一篇关于Redis构建分布式缓存系统的总结，结合之前项目上的使用场景，做一个系统性的梳理。</p><p>下面就以我做过的商品预约平台项目作为引子，引出分布式缓存设计的一些要点。</p><p>该商品预约平台的背景如下：</p><ul><li>该系统由多个微服务组成</li><li>预约的过程：用户可以选择指定门店，指定日期到店提领商品，如果对应门店和日期没有库存，则不能预约</li><li>因为“预约”的是未来时刻的库存，所以门店的未来某个时间剩余库存是通过一系列公式计算得出的。这个公式比较复杂，考虑到了用户指定的日期是否在配货周期内等因素，这里省略掉细节</li><li>每年节日高峰时期，用户会集中预约商品，导致服务压力骤增。又因为未来日期的库存需要动态计算的特点（比如A预约了1月1日的最后一件商品，B就会无法在该日预约），不同用户的预约操作会互相影响，严重时导致数据库死锁、数据不一致等问题</li></ul><p>基于以上背景，这个预约系统的设计必须将性能作为主要优化目标，而缓存作为性能优化的不二选择，就承担了重要职责。</p><h2 id=识别热点数据>识别热点数据 <a href=#%e8%af%86%e5%88%ab%e7%83%ad%e7%82%b9%e6%95%b0%e6%8d%ae class=anchor>🔗</a></h2><p>并不是所有数据都有必要被缓存，往往缓存的数据具有以下几个特点：</p><ul><li>读写比很高。如果写操作比读操作还多，缓存系统频繁更新会大大降低可用性</li><li>是热点数据。因为内存的价格昂贵，所以按照2-8原则，20%热点数据才值得被缓存</li><li>能够容忍短时间的不一致</li></ul><p>结合项目需要，排除掉一些不适合缓存的数据：</p><ul><li>对于那些只读的、配置相关的数据，只需要做进程缓存（使用Guava Cache），在服务启动时加载数据到内存就可以了</li><li>尽量用 CDN 和 Nginx 静态缓存来解决大部分不常更新的资源</li></ul><p>对于该预约项目，用户最频繁查询的数据是不同门店在不同日期下的库存数量。这类数据是缓存设计的重点照顾对象：</p><ul><li>用户选择了指定城市、指定门店后，系统会返回最近30天的库存信息，用户只可能修改其中一条信息。所以读写比很高</li><li>库存信息是预约订单流程的必备步骤，而且是跨服务调用（预约服务 -> 库存服务）的数据，所以涉及到大量网络请求、数据库查询。</li></ul><h2 id=指定性能优化的指标>指定性能优化的指标 <a href=#%e6%8c%87%e5%ae%9a%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e7%9a%84%e6%8c%87%e6%a0%87 class=anchor>🔗</a></h2><p>在即将完成业务系统开发时，我们就根据 <a href=https://sre.google/books/ target=_blank rel=noopener>Google SRE Books</a> 提到的四个黄金指标，制定了监控系统性能的四个维度：</p><ul><li>请求率</li><li>错误数，非200返回结果数量</li><li>响应时间</li><li>资源利用率（CPU、内存）</li></ul><p>我们使用 Prometheus + Grafana 的组合实现监控可视化，这样每次测试人员进行压力测试时，都可以通过这些指标对系统进行调整。缓存影响最大的指标是<strong>请求率</strong>（一般用TPS或者QPS）和<strong>响应时间</strong>。所以在设计缓存系统时，要不断参照这两个指标进行优化。</p><h2 id=缓存的设计的实践>缓存的设计的实践 <a href=#%e7%bc%93%e5%ad%98%e7%9a%84%e8%ae%be%e8%ae%a1%e7%9a%84%e5%ae%9e%e8%b7%b5 class=anchor>🔗</a></h2><h3 id=分级缓存>分级缓存 <a href=#%e5%88%86%e7%ba%a7%e7%bc%93%e5%ad%98 class=anchor>🔗</a></h3><p>为了不让某一接口或者微服务的缓存失效导致其他接口或服务的并发量暴增，就要针对不同来源（数据库的表、接口等）的数据做分级缓存。比如用户在一次查询中涉及到“附近可预约门店”的查询、“活动期间不同日期剩余库存”的查询、“已预约数量“的查询，这三种查询逐层依赖后边的查询结果。</p><p>假设如果只针对库存数量做缓存，一旦这部分缓存失效，那么“附近可预约门店”的查询就会直接访问数据库查询全部门店的剩余库存来确定哪个门店可以预约。这样就导致查询库存的接口并发量骤增。所以<strong>分级缓存一定程度上缓解了缓存雪崩的问题</strong>。</p><h3 id=自动化测试api参数合法性>自动化测试API参数合法性 <a href=#%e8%87%aa%e5%8a%a8%e5%8c%96%e6%b5%8b%e8%af%95api%e5%8f%82%e6%95%b0%e5%90%88%e6%b3%95%e6%80%a7 class=anchor>🔗</a></h3><p>我们的QA通常会写自动化脚本对后端API做定期的扫描，检查哪些接口的数据输入、输出有不合法的类型或是数值范围。除了巩固系统的健壮性，还能帮助缓存系统抵御<strong>缓存穿透</strong>的风险。</p><h3 id=缓存和数据库双写问题>缓存和数据库双写问题 <a href=#%e7%bc%93%e5%ad%98%e5%92%8c%e6%95%b0%e6%8d%ae%e5%ba%93%e5%8f%8c%e5%86%99%e9%97%ae%e9%a2%98 class=anchor>🔗</a></h3><p>这是一个“先淘汰缓存"还是”先写数据库“的问题。通常没有明确的最佳方法。我们采用 <a href=https://dzone.com/articles/cache-aside-pattern target=_blank rel=noopener><strong>Cache-Aside Pattern</strong></a> 的方式：</p><blockquote><ul><li><strong>失效</strong>：应用程序先从cache取数据，没有得到，则从数据库中取数据，成功后，放到缓存中。</li><li><strong>命中</strong>：应用程序从cache中取数据，取到后返回。</li><li><strong>更新</strong>：先把数据存到数据库中，成功后，再让缓存失效。</li></ul><p><strong>缺点：可能有小概率脏数据</strong>。比如，一个是读操作，但是没有命中缓存，然后就到数据库中取数据，此时来了一个写操作，写完数据库后，让缓存失效，然后，之前的那个读操作再把老的数据放进去，所以，会造成脏数据。</p></blockquote><p>考虑到写操作通常比读操作时间更长，所以 Cache-Aside Pattern 中的脏数据概率非常小，即便发生，用户在实际下单时系统仍然会去数据库里做数据校验，不会影响业务数据的正确性。</p><p>如果对缓存一致性有更高要求，可以采用<a href=https://juejin.cn/post/6844903805641818120 target=_blank rel=noopener>
延时双删策略或异步更新缓存
</a>。不过这两种方式本质都是用一定程度的串行化操作来解决并发造成的问题。</p><h3 id=预热>预热 <a href=#%e9%a2%84%e7%83%ad class=anchor>🔗</a></h3><p>预加载热点数据时需要注意的点是，要考虑好服务一旦重启或是生产环境发生事故，要避免服务重启后再次造成二次事故。</p><h2 id=缓存系统常见的问题和应对思路>缓存系统常见的问题和应对思路 <a href=#%e7%bc%93%e5%ad%98%e7%b3%bb%e7%bb%9f%e5%b8%b8%e8%a7%81%e7%9a%84%e9%97%ae%e9%a2%98%e5%92%8c%e5%ba%94%e5%af%b9%e6%80%9d%e8%b7%af class=anchor>🔗</a></h2><p>首先要保证应用服务能做好熔断、限流、降级的措施。然后再针对不同情况做应对处理。</p><h3 id=缓存雪崩>缓存雪崩 <a href=#%e7%bc%93%e5%ad%98%e9%9b%aa%e5%b4%a9 class=anchor>🔗</a></h3><p>原因：热点缓存数据批量过期，导致大量缓存失效。</p><p>解决思路：</p><ul><li>错开过期时间、随机过期时间</li><li>构建多级缓存</li><li>避免热点数据频繁淘汰（如修改Redis淘汰策略为LRU）</li><li>必要时限流、降级</li></ul><h3 id=缓存击穿>缓存击穿 <a href=#%e7%bc%93%e5%ad%98%e5%87%bb%e7%a9%bf class=anchor>🔗</a></h3><p>原因：热点Key突然过期。</p><p>解决思路：</p><ul><li>设计系统时针对性预防措施，比如热点Key的更新策略不依据时间，而是程序控制</li><li>配合监控和后台调整，保证高峰时段热点key可用</li><li>必要时限流、降级</li></ul><h3 id=缓存穿透>缓存穿透 <a href=#%e7%bc%93%e5%ad%98%e7%a9%bf%e9%80%8f class=anchor>🔗</a></h3><p>原因：黑客通过访问缓存中不存在的数据，将大量请求直达数据库。</p><p>解决思路：</p><ul><li>监控报警</li><li>在服务层做好熔断</li></ul><h2 id=小结>小结 <a href=#%e5%b0%8f%e7%bb%93 class=anchor>🔗</a></h2><p>在设计缓存系统时优先排除掉大部分不需要缓存或者通过进程本地缓存的数据。搭建合理的监控手段，自动化测试框架，再结合预热、缓存淘汰策略、双写策略等最佳实践方法，不断优化缓存性能。</p><p>尤其要注意缓存的集中常见问题：雪崩、击穿和穿透。做好应用服务的熔断、降级、限流措施，保证在事故发生时针对每种情况都有预案。</p></div><div class=tags><a href=https://sund.site/tags/%E7%BC%93%E5%AD%98>缓存</a>
<a href=https://sund.site/tags/%E5%88%86%E5%B8%83%E5%BC%8F>分布式</a>
<a href=https://sund.site/tags/redis>redis</a></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/stevedsun target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64C68.418278 72 72 68.418278 72 64V8c0-4.418278-3.581721999999999-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64C541083001e-24 68.418278 3.581722 72 8 72z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644 12 47.7406712 18.876 56.7718301 28.4145 59.9584121 29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482 23.343 56.1558981 21.9345 51.4693938 21.9345 51.4693938 20.844 48.6864054 19.2705 47.9454799 19.2705 47.9454799 17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943 21.843 46.6503662 23.1105 48.9634994 23.1105 48.9634994 25.2525 52.6455377 28.728 51.5823398 30.096 50.9649018 30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671 20.688 33.2052792 21.6225 31.0547881 23.1585 29.3696344 22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585 23.3925 22.9934585 25.4085 22.3459017 29.9925 25.4632101 31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101 46.5915 22.3459017 48.603 22.9934585 48.603 22.9934585 49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671 51.309 45.0917119 45.6975 47.1292571 40.3515 47.7256117 41.2125 48.4695491 41.9805 49.9393525 41.9805 52.1877301 41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://twitter.com/way2steve target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><p class=copyright>© 2021 Steve Sun</p><p class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-cactus-plus>nodejh</a></p></footer></body></html>