<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Implementing a Prometheus Exporter for Fluent-bit - The Context Works</title><meta name=theme-color><meta name=description content="Background Fluent-bit is a great tool for logging and monitoring, many teams are using it to collect metrics and logs. Prometheus is also a popular tool for metrics analysis, but if you want to output Fluent-bit data to Prometheus, the only way is to use the node-exporter input plugin, which has fixed metrics and data format.
In our case, we want to export specific input data into Prometheus, therefore we have to implement our Prometheus exporter in a customized Fluent-bit output plugin."><meta name=author content="Steve Sun"><link rel="preload stylesheet" as=style href=https://sund.site/main.min.css><link rel=preload as=image href=https://sund.site/theme.svg><link rel=preload as=image href=https://sund.site/images/profile.png><link rel=preload as=image href=https://sund.site/github.svg><link rel=preload as=image href=https://sund.site/rss.svg><script defer src=https://sund.site/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://sund.site/favicon.ico><link rel=apple-touch-icon href=https://sund.site/apple-touch-icon.png><meta name=generator content="Hugo 0.119.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-XJJVVQ0LBH"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XJJVVQ0LBH",{anonymize_ip:!1})}</script><meta itemprop=name content="Implementing a Prometheus Exporter for Fluent-bit"><meta itemprop=description content="We want to export specific input data into Prometheus, therefore we have to implement our Prometheus exporter in a customized Fluent-bit output plugin."><meta itemprop=datePublished content="2022-11-24T12:26:23+08:00"><meta itemprop=dateModified content="2022-11-24T12:26:23+08:00"><meta itemprop=wordCount content="717"><meta itemprop=keywords content="go,fluentbit,prometheus,"><meta property="og:title" content="Implementing a Prometheus Exporter for Fluent-bit"><meta property="og:description" content="We want to export specific input data into Prometheus, therefore we have to implement our Prometheus exporter in a customized Fluent-bit output plugin."><meta property="og:type" content="article"><meta property="og:url" content="https://sund.site/posts/2022/implementing-prometheus-exporter-for-fluentbit/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-24T12:26:23+08:00"><meta property="article:modified_time" content="2022-11-24T12:26:23+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Implementing a Prometheus Exporter for Fluent-bit"><meta name=twitter:description content="We want to export specific input data into Prometheus, therefore we have to implement our Prometheus exporter in a customized Fluent-bit output plugin."><link rel=canonical href=https://sund.site/posts/2022/implementing-prometheus-exporter-for-fluentbit/><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2639081419131654" crossorigin=anonymous></script></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=https://sund.site/>The Context Works</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/stevedsun target=_blank rel=me>github</a>
<a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://sund.site/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"><article><header class=mb-16><h1 class="!my-0 pb-2.5">Implementing a Prometheus Exporter for Fluent-bit</h1><div class="text-sm antialiased opacity-60"><time>Nov 24, 2022</time></div></header><section><h2 id=background>Background</h2><p>Fluent-bit is a great tool for logging and monitoring, many teams are using it to collect metrics and logs. Prometheus is also a popular tool for metrics analysis, but if you want to output Fluent-bit data to Prometheus, the only way is to use the node-exporter input plugin, which has fixed metrics and data format.</p><p>In our case, we want to export specific input data into Prometheus, therefore we have to implement our Prometheus exporter in a customized Fluent-bit output plugin.</p><p>Today I want to share the final solution for this case. The complete demo code can be found on this Github repo: <a href=https://github.com/stevedsun/fluent-bit-output-prometheus-demo>https://github.com/stevedsun/fluent-bit-output-prometheus-demo</a></p><h2 id=fluent-bit-output-plugin>Fluent-bit Output Plugin</h2><p>Fluent-bit provides a way to implement your Golang plugin. (See <a href=https://docs.fluentbit.io/manual/v/1.9-pre/development/golang-output-plugins>Fluent-bit Go Output Plugin</a>)</p><p>We can run an asynchronous HTTP server as the Prometheus exporter when Fluent-bit plugin initializing, and transform the Fluent-bit records to Prometheus metrics format when Fluent-bit flushes a record to the output plugin.</p><p>To implement a Fluent-bit output plugin, there are four call-back functions we need to overwrite.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//export FLBPluginRegister
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FLBPluginRegister</span>(<span style=color:#a6e22e>def</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Here we define the plugin name and description.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>FLBPluginRegister</span>(<span style=color:#a6e22e>def</span>, <span style=color:#e6db74>&#34;promexporter&#34;</span>, <span style=color:#e6db74>&#34;Prometheus Exporter&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//export FLBPluginInit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FLBPluginInit</span>(<span style=color:#a6e22e>plugin</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We can extract output plugin parameters from `FLBPlguinConfigKey`.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>FLBPluginConfigKey</span>(<span style=color:#a6e22e>plugin</span>, <span style=color:#e6db74>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>passwd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>FLBPluginConfigKey</span>(<span style=color:#a6e22e>plugin</span>, <span style=color:#e6db74>&#34;password&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Here we can run a new Prometheus exporter server.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>NewExporter</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>FLB_OK</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//export FLBPluginFlushCtx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FLBPluginFlushCtx</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>data</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>length</span> <span style=color:#a6e22e>C</span>.<span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>tag</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>char</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Here we process every record, extract it and ship to exporter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dec</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>data</span>, int(<span style=color:#a6e22e>length</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Extract Record
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>ret</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>record</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>GetRecord</span>(<span style=color:#a6e22e>dec</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ret</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>record</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// You have to extract record here, ship them to exporter.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>FLB_OK</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//export FLBPluginExit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FLBPluginExit</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>()); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Here we have to close go channel and daemon exporter server.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	close(<span style=color:#a6e22e>collector</span>.<span style=color:#a6e22e>buff</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>FLB_OK</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Note</strong>! You should not remove the comment lines above the function, they are important for building .so files.</p><pre><code> //export FLBPluginExit
</code></pre><h2 id=the-exporter-http-server>The Exporter HTTP Server</h2><p>The next step is to implement the HTTP server and make it run on a daemon.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Here we start a background server on port 8989, the server will handle `/metrics` path, prometheus exporter will implement the handler.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>startHttpServer</span>(<span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>, <span style=color:#a6e22e>reg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>Registry</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Server</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Server</span>{<span style=color:#a6e22e>Addr</span>: <span style=color:#e6db74>&#34;:8989&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;/metrics&#34;</span>, <span style=color:#a6e22e>promhttp</span>.<span style=color:#a6e22e>HandlerFor</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>reg</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>promhttp</span>.<span style=color:#a6e22e>HandlerOpts</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>EnableOpenMetrics</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Registry</span>:          <span style=color:#a6e22e>reg</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>ListenAndServe</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ErrServerClosed</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;ListenAndServe():&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>srv</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewExporter</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>reg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>NewRegistry</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>reg</span>.<span style=color:#a6e22e>MustRegister</span>(<span style=color:#a6e22e>collector</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Here, we start a new HTTP server and save the instance object into a golang sync.WaitGroup, so that we can watch its status in `FLBPluginExit`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>wg</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>srv</span> = <span style=color:#a6e22e>startHttpServer</span>(<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>wg</span>, <span style=color:#a6e22e>reg</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=the-exporter-collector>The Exporter Collector</h2><p>Now we have an HTTP server, but if we want to make it an exporter, we have to define the <strong>collector</strong>. The collector is a Prometheus concept that implements two call-back functions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Here for instance, we define metrics to collect cpu info, which reuses the default Fluent-bit CPU metrics input data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewMyCollector</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>myCollector</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>myCollector</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>metrics</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>Desc</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;cpu&#34;</span>: <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>NewDesc</span>(
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;cpu&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;Collect CPU usage&#34;</span>,
</span></span><span style=display:flex><span>				[]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;cpu&#34;</span>, <span style=color:#e6db74>&#34;mode&#34;</span>}, <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>			),
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		<span style=color:#75715e>// this buff is a golang channel object, which receive data sending from `FLBPluginFlushCtx` function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>buff</span>: make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>cpuMetrics</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// `Describe` send our metrics name and defination to Prometheus exporter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>collector</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>myCollector</span>) <span style=color:#a6e22e>Describe</span>(<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>Desc</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>desc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>collector</span>.<span style=color:#a6e22e>metrics</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>desc</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// `Collect` will read data from golang channel `buff` and send data to HTTP server handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>collector</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>myCollector</span>) <span style=color:#a6e22e>Collect</span>(<span style=color:#a6e22e>ch</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>Metric</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>desc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>collector</span>.<span style=color:#a6e22e>metrics</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>metric</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>collector</span>.<span style=color:#a6e22e>buff</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>cpu</span>, <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>mode</span>, <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>value</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>MustNewConstMetric</span>(<span style=color:#a6e22e>desc</span>, <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>GaugeValue</span>, <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>cpu</span>, <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>mode</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>collector</span> = <span style=color:#a6e22e>NewMyCollector</span>()
</span></span></code></pre></div><h2 id=building-so-file-and-running-in-fluent-bit>Building so file and running in Fluent-bit</h2><p>Last but not least, building Golang plugin into so file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -buildmode<span style=color:#f92672>=</span>c-shared -o out_prom_exporter.so prom_exporter.go
</span></span></code></pre></div><p>Run Fluent-bit with CLI flags:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>fluent-bit -v -e ./out_prom_exporter.so -i cpu -o promexporter
</span></span></code></pre></div><p>That&rsquo;s all steps to implement a customized Fluent-bit Prometheus exporter plugin. To see more details, please go to the Github repo <a href=https://github.com/stevedsun/fluent-bit-output-prometheus-demo%3E>https://github.com/stevedsun/fluent-bit-output-prometheus-demo></a>.</p></section><footer class="mt-12 flex flex-wrap"><a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://sund.site/tags/go>go</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://sund.site/tags/fluentbit>fluentbit</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://sund.site/tags/prometheus>prometheus</a></footer><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://sund.site/posts/2022/essay-2022-12-04/><span class=mr-1.5>←</span><span>构建一幅图景，了解一个环境</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://sund.site/posts/2022/fogg-behavior-model/><span>渐进式地改变生活习惯——我对福格行为模型的理解</span><span class=ml-1.5>→</span></a></nav><div class=mt-24 id=graphcomment></div><script type=text/javascript>var __semio__params={graphcommentId:"steve-sun",behaviour:{}};function __semio__onload(){__semio__gc_graphlogin(__semio__params)}(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.onload=__semio__onload,e.defer=!0,e.src="https://integration.graphcomment.com/gc_graphlogin.js?"+Date.now(),(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2024
<a class=link href=https://sund.site/>The Context Works</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>✎ Paper</a></footer></body></html>